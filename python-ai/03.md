안녕하세요, 여러분! 반갑습니다.
지난 시간에 증권사 회원 가입과 API 발급을 모두 완료했는데요, 오늘은 드디어 코드를 통해 증권사 API와 직접 소통하는 방법을 배워보도록 하겠습니다.

### 데이터 조회 방법 큰 그림 소개

먼저 주식 데이터를 어떻게 얻을 수 있는지 큰 그림을 설명드릴게요.
우리가 만든 프로그램에서 증권사에 주식 가격 데이터를 요청하면, 증권사가 그 데이터를 보내주는 방식입니다.

여기서 각각의 구성 요소를 자세히 살펴보면,
첫 번째로 '우리 프로그램'은 말 그대로 우리가 작성하고, 수정하고, 실행하는 코드를 의미합니다.
두 번째로 '증권사에 요청'한다는 것은 실제로는 지정된 domain(도메인) 주소로 네트워크 요청을 보내는 것을 말합니다.

이 요청을 보내는 방법에는 requests(리퀘스츠) 라이브러리를 사용합니다.
혹시 '파이썬 ChatGPT 활용' 강의나 '파이썬 업무 자동화' 강의를 들으신 분들은 기억하실 텐데요,
requests 라이브러리는 파이썬에서 인터넷을 통해 웹 서버와 데이터를 주고받을 수 있게 해주는 도구입니다.

우리는 이 라이브러리에 주어진 양식: url, header, body(유알엘, 헤더, 바디) 등을 채워서 요청을 보내면 됩니다.

한국투자증권은 REST(레스트) API 형식으로 정보를 제공하고 있고,

지난 시간에 살펴본 API 문서에서 안내하는 양식에 맞춰 요청 코드를 작성하면 됩니다.

그렇게 요청의 응답을 받으면, 이제 우리가 필요한 대로 사용하면 되는 것이죠.

예를 들어 볼까요?

이 화면은 이제 많이들 익숙하신 vscode(브이에스 코드) 화면이죠?

지금 보시는 건 주가 데이터를 가져와서 간단히 출력해 본 화면이에요.

항상 증권사 앱 안에만 있던 데이터가 내 손 안에 있다니, 정말 재밌죠?

- 코드 변경
  - before
    ![image.png](attachment:640acb24-392b-4c8f-9d47-b25ac11d346f:image.png)
  - after
    ```python
    import requests
    import pandas as pd

    PATH = "uapi/overseas-price/v1/quotations/dailyprice"
    URL = f"{KIS_URL_BASE}/{PATH}"

    headers = {
        'content-type': 'application/json',
        'authorization': f'Bearer {KIS_ACCESS_TOKEN}',
        'appkey': KIS_APP_KEY,
        'appsecret': KIS_APP_SECRET,
        'tr_id': 'HHDFS76240000',
        'custtype': 'P'
    }

    params = {
        "AUTH": "",  # 기본 값 (Null)
        "EXCD": "NAS",  # 거래소 코드 (예: 'NAS', 'NYS')
        "SYMB": "AAPL",  # 종목 코드 (예: 'TSLA')
        "GUBN": "0",  # 조회 구분 (0: 일, 1: 주, 2: 월)
        "BYMD": "",  # 조회 기준 일자: 한 번 호출에 이 날까지 100건 조회
        "MODP": "1",  # 수정주가 반영 여부 (0: 미반영, 1: 반영)
    }

    response = requests.get(URL, headers=headers, params=params)
    response_data = response.json()

    df = pd.DataFrame(response_data["output2"])
    df["datetime"] = pd.to_datetime(df["xymd"], format="%Y%m%d")
    # 필요한 컬럼만 선택하고 이름 변경
    df.rename(columns={
            "open": "open",
            "high": "high",
            "low": "low",
            "clos": "close",
            "tvol": "volume",
        },
        inplace=True,
    )
    df = df[
        ["datetime", "open", "high", "low", "close", "volume"]
    ]
    df
    ```

### Access Token 발급

자, 그럼 가장 먼저 API 호출을 통해 access token(액세스 토큰)을 받아보도록 하겠습니다.

access token(액세스 토큰)이란 쉽게 말해 API에 접근하기 위해 필요한 비밀번호라고 생각하시면 됩니다.

한국투자증권 API에서는, 지난 시간에 발급 받은 app key(앱 키), secret(시크릿)에 더해 이 access token 까지 사용해야 합니다.

아무래도 보안이 중요한 분야다 보니, 다양한 안전 장치를 갖추고 있는 것이죠.

access token은 유효 기간이 정해져 있어서, 일반 사용자 기준으로 24시간에 한 번씩은 갱신해야 한다는 것도 참고해주세요!

이제 실제로 토큰을 발급받는 코드를 같이 살펴보도록 하겠습니다.

- 코드
  ```python
  # 필요한 라이브러리 임포트
  import json
  import requests

  KIS_URL_BASE = "https://openapivts.koreainvestment.com:29443"
  KIS_APP_KEY = "asdffe..."
  KIS_APP_SECRET = "dabt+1q..."

  # 환경 변수를 사용하여 KIS 접근 토큰 발급
  headers = {"content-type": "application/json"}
  body = {
  		"grant_type": "client_credentials",
  		"appkey": KIS_APP_KEY,       # 미리 발급받은 appkey 사용
  		"appsecret": KIS_APP_SECRET  # 미리 발급받은 appsecret 사용
  }

  PATH = "oauth2/tokenP"
  URL = f"{KIS_URL_BASE}/{PATH}" # 요청을 전송할 domain

  res = requests.post(URL,
                      headers=headers,
                      data=json.dumps(body))

  KIS_ACCESS_TOKEN = res.json().get("access_token")
  KIS_ACCESS_TOKEN
  ```

보시는 것처럼 app key(앱 키)와 app secret(앱 시크릿)을 requests(리퀘스츠) 라이브러리로 전송해서 token(토큰)을 발급받게 되는데요,
문서에 안내된 domain과 url 주소로 app key와 app secret을 body에 담아 보내면 됩니다.

이때 json(제이슨)은 파이썬의 딕셔너리와 거의 똑같은 데이터 구조인데요, 웹 통신에서 데이터를 주고 받을 때, 거의 표준으로 사용되는 형태입니다.

json 모듈을 사용해, 딕셔너리를 json 형태로 변환하거나, json 데이터를 파이썬의 딕셔너리 형태로 변환할 수 있습니다.

혹시 header(헤더)가 궁금하신 분들이 계실 텐데요.

헤더에는 보통 요청에 대한 기본 정보나 설정 값이 들어갑니다.

전달하는 데이터의 종류, access token, 요청을 보내는 사용자 분류 정보 등이 들어가는 경우가 많습니다.

토큰을 발급받는 기능은 비교적 간단해서 header에 특별히 필요한 내용이 없는데요,

단순히 데이터의 타입이 Json이라는 정도만 표시되어 있죠.

나중에 복잡한 header를 요구하는 기능을 사용할 때도, API 문서에서 안내하는 형식대로 요청을 보내면 쉽게 데이터를 얻을 수 있습니다.

자, 코드를 실행해보면, Access token이 잘 발급된 것을 확인할 수 있네요!

이 토큰도 지난 시간에 발급한 app key, secret처럼 아주아주 중요하고 위험한 정보이니, 유출되지 않게 꼭 조심하세요!

### 주가 데이터에 대해 조금 더 자세히 알아보자

자, 그럼 이제 주가 데이터를 살펴보도록 하겠습니다!

한국투자증권 API를 통해 국내외 주식에 대한 다양한 데이터를 조회할 수 있는데요,

예를 들면 주식 당일 분봉 조회, 주식 일별 분봉 조회, 국내주식 기간별 시세~~(일/주/월/년)~~, 해외주식 기간별 시세 등이 있습니다.

혹시 분봉이나 일봉이라는 용어가 생소하신 분들을 위해 간단히 알려드리겠습니다!

‘봉’이란 일정 기간 동안의 주가 변동을 나타내는 기본 단위입니다.

주식 차트에서 주가의 변동을 시각적으로 표현하기 위해 사용하는데요,

1개의 분봉은 1분 동안의 주가 변동을, 1개의 일봉은 1일 동안의 주가 변동을 보여줍니다.

이 ‘봉’은 마치 양초와 비슷하게 생겨서, 영어로는 양초를 뜻하는 ‘캔들 스틱’이라고 부르기도 한답니다!

마지막으로 OHLCV(오 에이치 엘 씨 브이)라는 중요한 개념을 짚고 넘어가도록 하겠습니다.
OHLCV는 캔들을 구성하는 다섯 가지 주요 정보로, 주식 데이터에서 가장 기본이 되는 요소입니다.
시가(Open), 고가(High), 저가(Low), 종가(Close), 거래량(Volume)의 영문 첫 글자를 따서 부르는 말인데요,

각각의 의미를 살펴보면,
Open(오픈)인 시가는 해당 거래 기간의 시작 시점 가격,
High(하이)인 고가는 거래 기간 중 최고 가격,
Low(로우)인 저가는 거래 기간 중 최저 가격,
Close(클로즈)인 종가는 거래 마감 시점의 가격,
그리고 Volume(볼륨)인 거래량은 해당 기간 동안 거래된 주식의 총 수량을 의미합니다.

![image.png](attachment:2a68f9ea-c54f-47b5-9523-86e2432183ee:image.png)

예를 들어, 2025년 2월 13일 애플 주가를 한 번 볼까요?

이 날 일봉의 시가는 약 236 달러, 고가는 242달러, 저가는 235달러, 종가는 241달러, 거래량은 약 5천3백만 건이었네요.

그럼 이 날 하루 동안 실제로 주가가 어떻게 움직였는지 좀 더 자세히 보기 위해, 5분봉 차트를 살펴보겠습니다.

여기서는 캔들 하나가 5분 동안의 주가 움직임을 나타내요.

이 날 하루가 시작할 때, 현지 시각 09시 30분에는 약 236달러에서 시작하고, 한 번 쭉 올라왔다가 다시 금방 내려가 10시 5분 경에는 약 235 달러 부근까지 떨어집니다. 그후 하루 종일 전반적으로 오르는 추세를 이어가다가, 오후 2시 55분 경에는 242 달러까지 찍고, 살짝 내려와 16시에 약 241 달러로 거래가 종료되었습니다.

어때요, 아까 본 일봉 캔들의 시가, 고가, 저가, 종가와, 지금 5분봉으로 살펴본 1일 동안 움직임에서의 시작 가격, 최고 가격, 최저 가격, 최종 가격이 똑같은 걸 볼 수 있죠?

![image.png](attachment:e9113f39-1a41-46c9-bc99-3433e051d7b2:image.png)

자, 이렇게 오늘은 API 요청 방법과 주가 데이터의 기본 개념들을 알아보았는데요,
다음 시간에는 이 내용을 바탕으로 실제로 데이터를 가져와보도록 하겠습니다.
그럼 다음 시간에 뵙겠습니다!

---

### 1️⃣ API를 통한 데이터 요청

- 증권사 API를 통해 주식 데이터를 요청하고 응답을 받을 수 있습니다.
- requests 라이브러리를 사용해 웹 서버와 데이터를 주고받습니다.
  - URL, header, body 등의 양식을 채워 요청을 보냅니다.
  - REST API 형식으로 정보를 제공받습니다.
- API 문서에서 안내하는 양식에 맞춰 요청 코드를 작성해야 합니다.

### 2️⃣ Access Token 발급받기

- Access Token은 API에 접근하기 위해 필요한 인증 정보입니다.
  - App Key, Secret과 함께 사용되는 보안 장치입니다.
  - 유효 기간이 정해져 있어 일반 사용자 기준 24시간마다 갱신이 필요합니다.

```python
# Access Token 발급받기
import os
import json
import requests
from dotenv import load_dotenv
import pandas as pd

# .env 파일 로드하기
load_dotenv()

# 환경 변수에서 필요한 값 가져오기
KIS_URL_BASE = os.getenv("KIS_URL_BASE")
KIS_APP_KEY = os.getenv("KIS_APP_KEY")
KIS_APP_SECRET = os.getenv("KIS_APP_SECRET")

# 환경 변수를 사용하여 KIS 접근 토큰 발급하기
headers = {"content-type": "application/json"}
body = {
    "grant_type": "client_credentials",
    "appkey": KIS_APP_KEY,
    "appsecret": KIS_APP_SECRET
}

PATH = "oauth2/tokenP"
URL = f"{KIS_URL_BASE}/{PATH}"

res = requests.post(URL, headers=headers, data=json.dumps(body))

KIS_ACCESS_TOKEN = res.json().get("access_token")
print(KIS_ACCESS_TOKEN)
```

<aside>
➕ **JSON과 딕셔너리**

- JSON은 웹 통신에서 데이터를 주고받을 때 사용하는 표준 형식입니다.
- 파이썬의 딕셔너리와 유사한 key-value 쌍의 데이터 구조를 가집니다.
- 파이썬의 json 모듈을 사용해 딕셔너리와 JSON 간의 변환이 가능합니다.
</aside>

<aside>
➕ **HTTP 요청의 헤더**

- 헤더는 요청에 대한 기본 정보나 설정 값을 포함합니다.
- 데이터 타입, Access Token, 사용자 분류 정보 등이 포함될 수 있습니다.
- API 문서에서 안내하는 형식에 맞춰 헤더를 구성해야 합니다.
</aside>

### 3️⃣ 주가 데이터 이해

- 국내외 주식에 대한 다양한 데이터를 조회할 수 있습니다.
  - 주식 당일 분봉 조회
  - 주식 일별 분봉 조회
  - 국내주식 기간별 시세
  - 해외주식 기간별 시세
- 봉은 일정 기간 동안의 주가 변동을 나타내는 기본 단위입니다.
  - 1분봉은 1분 동안의 주가 변동을 보여줍니다.
  - 1일봉은 1일 동안의 주가 변동을 보여줍니다.
  - 캔들 스틱(Candle Stick)이라고도 부릅니다.
- OHLCV는 주식 데이터의 다섯 가지 주요 구성 요소입니다.
  - O(Open): 시가, 거래 기간의 시작 시점 가격
  - H(High): 고가, 거래 기간 중 최고 가격
  - L(Low): 저가, 거래 기간 중 최저 가격
  - C(Close): 종가, 거래 마감 시점의 가격
  - V(Volume): 거래량, 거래 기간 동안의 총 거래 수량

<aside>
⚠️ **여기서 잠깐!**

- Access Token은 매우 중요한 보안 정보이므로 절대 유출되지 않도록 주의해야 합니다.
- 환경 변수를 사용해 API 키와 토큰을 안전하게 관리하는 것이 좋습니다.
</aside>
