안녕하세요, 여러분! 이번 시간에는 주식 분석의 또 다른 중요한 축인 '기본적 분석'에 대해 배워보겠습니다.

지난 시간까지 우리는 주가 차트와 패턴을 활용하는 '기술적 분석'에 대해 살펴봤는데요. 오늘부터는 기업의 실제 가치를 평가하는 '기본적 분석'에 대해 알아보겠습니다.

## 1. 기본적 분석이란?

기본적 분석은 기업의 재무제표, 사업 모델, 경쟁력, 산업 환경 등을 분석해 기업의 내재가치를 평가하는 방법입니다.

간단히 말해, "이 회사가 정말 돈을 잘 벌고 있는지?", "앞으로의 성장 가능성은 어떤지?", "부채는 얼마나 되는지?" 등을 파악해서 투자 가치가 있는지 판단하는 거죠.

주식 투자의 대가 워렌 버핏이 주로 사용하는 분석 방법이기도 합니다!

기본적 분석의 핵심 자료는 바로 '재무제표'입니다. 재무제표는 기업의 재무 상태와 경영 성과를 보여주는 공식 문서로, 크게 세 가지로 구성됩니다:

1. 첫 번째, 재무상태표는 기업이 보유한 자산, 부채, 자본을 보여줍니다.
2. 두 번째, 손익계산서는 기업의 매출, 비용, 이익을 보여줍니다.
3. 세 번째, 현금흐름표는 실제 현금의 유입과 유출을 보여줍니다.

이런 재무제표는 분기별, 연간 단위로 공시되며, 우리나라에서는 금융감독원 전자공시시스템: DART(다트)에서 확인할 수 있습니다.

그리고 미국 기업들은 미국 증권거래위원회:SEC(에스이씨)의 EDGAR(에드가)(Electronic Data Gathering, Analysis, and Retrieval) 시스템에서 확인할 수 있어요.

야후 파이낸스나 네이버 금융 등의 포털에서도 정보를 확인할 수 있지만, 이번 시간에는 가장 공식적인 소스에서 정보를 가져오는 연습을 해볼게요.

## 2. 재무제표 데이터 가져오기

자, 이제 실제로 재무제표 데이터를 가져와 보겠습니다. 오늘은 애플(AAPL)을 예시로 데이터를 가져와 볼게요.

먼저 필요한 라이브러리들을 불러오겠습니다:

```python
# library import
import pandas as pd
import requests
import os

from pathlib import Path
from datetime import datetime
from sec_cik_mapper import StockMapper
from dotenv import load_dotenv
from openai import OpenAI
from pathlib import Path
from datetime import datetime, timedelta
```

여기서 `sec_cik_mapper` (에스이씨 씨아이케이 매퍼)는 AAPL 같은 종목 코드, CIK(Central Index Key), 기업명 등을 서로 대응시켜주는 라이브러리입니다. CIK는 SEC에서 사용하는 고유한 코드입니다. EDGAR(에드가)시스템에서 재무정보를 가져오기 위해서는 우리에게 익숙한 종목 코드를 SEC의 고유 키로 변환하는 작업이 필요합니다.

이제 환경 변수를 로드하고, 파일 저장 경로도 설정해주겠습니다:

```python
load_dotenv()

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
USER_AGENT = os.getenv("USER_AGENT")            # sec edgar api 사용 시 필요

openai_client = OpenAI(api_key=OPENAI_API_KEY)

```

```python
# 조회할 종목
market = "ovs"  # 해외
stock_code = "AAPL" # 종목코드

# 파일 경로 지정
root_path = Path(__vsc_ipynb_file__).parent
data_path = root_path / "data"    # 차트 데이터 경로
report_path = root_path / "report"    # 분석 보고서 경로

# 경로 생성
data_path.mkdir(parents=True, exist_ok=True)
report_path.mkdir(parents=True, exist_ok=True)
```

이제 본격적으로 SEC EDGAR(에스이씨 에드가) API를 사용해 재무제표 데이터를 가져와 보겠습니다:

```python
# 종목코드 -> SEC에서 사용하는 CIK 코드로 매핑
stock_mapper = StockMapper()
cik = stock_mapper.ticker_to_cik[stock_code]

# API 요청 위한 헤더 설정
HEADERS = {
    "User-Agent": USER_AGENT,           # 이름 (이메일) 형식 필요
    "Accept-Encoding": "gzip, deflate",
    "Host": "data.sec.gov",
    "Connection": "keep-alive"
}

# sec에서 재무제표 데이터 json 가져오기
url = f"https://data.sec.gov/api/xbrl/companyfacts/CIK{cik}.json"
response = requests.get(url, headers=HEADERS)
data = response.json()

```

자, 이제 받아온 데이터를 살펴볼까요? 이 데이터는 JSON 형식으로, 먼저 CIK 코드와 기업이름이 있고, 하위 항목에는 각 재무정보와 단위, 보고서 시점, 재무제표 각 항목의 값 등이 기록되어 있습니다.

(데이터 구조 간단히 설명)

```python
(재무정보: 기업이 일정 기간 동안 벌어들인 돈, 쓴 돈, 가지고 있는 돈의 상태를 수치로 정리한 정보)

"AccountsPayable (외상매입금)" -> 재무정보 중 하나 = 재무항목
(해당 값이 여러개 있으나 현재 생략되어있음, ex, Revenues, NetIncomeLoss)
(AccountsPayable: 기업이 다른 회사에 아직 지급하지 않은 금액, 단기 채무)

"units" -> 해당 항목의 값이 어떤 단위로 측정되었는지를 나타내며, 현재는 USD (미국 달러)로 표기되어있음

보고서 시점 (USD 안의 내용):	각 항목 내의 값들 (end, fy, fp, filed)
- end: 회계 기간 종료일
- fy: 회계연도
- fp: 회계분기
- filed: 보고서 제출일

val (USD 안의 내용): 재무제표 각 항목의 값
-> 애플은 외상매입금이 미국 달러 기준으로 5520000000 달러 (55억 달러)라는 뜻
```

```json
{
  "cik": 320193,
  "entityName": "Apple Inc.",
  "facts": {
    // ... 더 많은 항목들
    "us-gaap": {
      "AccountsPayable": {
        "label": "Accounts Payable",
        "description": "...",
        "units": {
          "USD": [
            {
              "end": "2008-09-27",
              "val": 5520000000,
              "accn": "0001193125-09-153165",
              "fy": 2009,
              "fp": "Q3",
              "form": "10-Q",
              "filed": "2009-07-22"
            }
            // ... 더 많은 데이터
          ]
        }
      }
      // ... 더 많은 항목들
    }
  }
}
```

이 데이터에서 연간 재무제표(10-K) 데이터를, 그중에서도 최근 3년 치만 추출하고자 합니다.

- 코드
  - before
    ```python
    company_name = data["entityName"]   # 기업명
    us_gaap = data.get("facts", {}).get("us-gaap", {})  # 데이터

    financial_data = []
    for item, details in us_gaap.items():
        for unit in details["units"].keys():
            for entry in details["units"][unit]:
                # 날짜 정보 가져오기
                end_date = entry.get("end", "")
                # 회계 연말 데이터만 선택
                if entry.get("fp", "") == "FY":
                    # 최근 3년치만 활용
                    formatted_end_date = datetime.strptime(end_date, "%Y-%m-%d")

                    if formatted_end_date > datetime.now()-timedelta(days=3*365):
                        # 중복 데이터 처리: 10-K/A 있는 경우 덮어쓰기
                        if any(data["Date"] == end_date and data["Metric"] == item for data in financial_data):
                            financial_data.pop()
                        financial_data.append({
                            "Date": end_date,
                            "Metric": item,  # 재무 항목명 (예: Revenues, NetIncomeLoss)
                            "Unit": unit,
                            "Value": entry.get("val", "")
                        })

    df = pd.DataFrame(financial_data)
    df.to_csv(data_path / f"{stock_code}.csv", index=False)
    ```
  ```python
  # 기업명
  company_name = data["entityName"]
  # 데이터
  us_gaap = data.get("facts", {}).get("us-gaap", {})

  financial_data = []
  existing_entries = set()
  three_years_ago = datetime.now() - timedelta(
                                          days=3*365)
  # metric (재무 항목명, 예: Revenues, NetIncomeLoss)
  for metric, details in us_gaap.items():
      for unit, entries in details["units"].items():
          for entry in entries:
              # 날짜 정보 가져오기
              end_date = entry.get("end", "")
              # 회계 연말 데이터만 선택
              if entry.get("fp", "") != "FY":
                  continue

              # 최근 3년치만 활용
              formatted_end_date = datetime.strptime(
                                  end_date, "%Y-%m-%d")
              if formatted_end_date <= three_years_ago:
                  continue

              # 중복 데이터 처리: 10-K/A 있는 경우 덮어쓰기
              key = (end_date, metric)
              if key in existing_entries:
                  financial_data.pop()
              existing_entries.add(key)

              financial_data.append({
                  "Date": end_date,
                  "Metric": metric,
                  "Unit": unit,
                  "Value": entry.get("val", "")
              })

  df = pd.DataFrame(financial_data)
  df.to_csv(data_path / f"{stock_code}.csv", index=False)
  ```

상당히 복잡한 JSON 구조지만, 원하는 항목이 명확하다면 AI를 활용해 추출을 위한 코드를 쉽게 생성할 수 있습니다. 코드 내용을 간단히 설명하자면:

1. ‘미국 회계기준’ 정보가 들어있는 ‘갭’ 항목 에서 모든 재무 지표를 추출합니다.
2. 이 중 연간 보고서 데이터만 선택합니다. (회계연도 전체 결산 데이터에 해당하는 `fp` 값이 "FY"인 → CG로 표시)
3. 날짜(`end`)를 확인해 최근 3년치 데이터만 선택합니다.
4. 이전에 저장했던 데이터가 있을 경우, 최신 데이터로 업데이트합니다 (10-K/A는 수정된 연간 보고서를 의미합니다).
5. 추출한 데이터를 데이터프레임으로 변환하고 CSV 파일로 저장합니다.

결과로 생성된 CSV 파일은 다음과 같은 형태인데요, 각 항목(`Metric`)의 3년치 데이터를 단위, 값과 함께 추출한 것을 확인할 수 있습니다.

```
         Date                        Metric Unit         Value
0  2022-09-24        AccountsPayableCurrent  USD  6.411500e+10
1  2023-09-30        AccountsPayableCurrent  USD  6.261100e+10
2  2024-09-28        AccountsPayableCurrent  USD  6.896000e+10
3  2022-09-24  AccountsReceivableNetCurrent  USD  2.818400e+10
4  2023-09-30  AccountsReceivableNetCurrent  USD  2.950800e+10
5  2024-09-28  AccountsReceivableNetCurrent  USD  3.341000e+10
6  2022-09-24     AccruedIncomeTaxesCurrent  USD  6.552000e+09
7  2023-09-30     AccruedIncomeTaxesCurrent  USD  8.819000e+09
8  2024-09-28     AccruedIncomeTaxesCurrent  USD  2.660100e+10
9  2022-09-24  AccruedIncomeTaxesNoncurrent  USD  1.665700e+10
...
```

## 3. AI를 활용한 기본 분석 보고서 생성

자, 이제 우리가 수집한 재무제표 데이터를 활용해 AI에게 분석 보고서를 작성하도록 해볼게요.

먼저 간단한 프롬프트를 작성해봅시다:

```python
prompt_fund_dev = f"""
너는 투자 분석가야. 다음 기업 {company_name}의 연간 사업보고서를 참고하여 이 기업의 재무 상태를 요약, 분석한 Markdown 형식의 보고서를 한국어로 출력해줘.
직접적인 투자 의견을 제시하는 것은 피하고, 기업의 최근 재무 상태 분석에 초점을 맞춰줘."""

prompt_fund_user = f"""
최근 3년간 사업보고서: {df.to_json(indent=4, force_ascii=False)}
"""
```

지난 시간 기술적 분석에서 했던 것처럼, 프롬프트는 두 부분으로 나뉩니다.

1. `prompt_fund_dev`(개발자 프롬프트)에서는 AI에게 투자 분석가 역할을 부여하고, 어떤 형태의 보고서를 작성해야 하는지 지시합니다.
2. 다음으로 `prompt_fund_user`(사용자 프롬프트)에 실제 분석할 데이터를 제공합니다.

이제 OpenAI API를 호출하여 보고서를 생성해보겠습니다:

```python
# OpenAI API 호출
reasoning_effort = "low"
response = openai_client.chat.completions.create(
    model="o3-mini",
    messages=[
        {"role": "developer", "content": prompt_fund_dev},
        {"role": "user", "content": prompt_fund_user}
    ],
    reasoning_effort=reasoning_effort
)

# 응답 저장
with open(report_path / f"{stock_code}_v1.md", "w") as f:
    f.write(response.choices[0].message.content)
```

여기서도 낮은 추론 강도의 추론 모델을 사용했습니다. 투입할 수 있는 비용, 시간에 따라 모델과 추론 강도는 다르게 설정할 수 있습니다.

이렇게 실행했을 때 다음과 같은 보고서가 생성되었습니다.

```markdown
아래는 최근 연간 사업보고서 데이터를 토대로 산출한 Apple Inc.의 재무 상태 요약 및 분석 보고서입니다. 이 보고서는 투자 조언이 아닌, 공개된 수치와 주요 재무지표 변동에 기반한 분석 내용임을 참고하시기 바랍니다.

---

## 1. 주요 재무지표 개요

- **자산(Assets)**

  - 2022년: 약 3,527억 5,500만 USD
  - 2023년: 약 3,525억 8,300만 USD
  - 2024년: 약 3,649억 8,000만 USD  
    → 전체 자산은 2022년 대비 2024년에 소폭 증가하는 추세를 보입니다.

- **부채(Liabilities)**

  - 2022년: 약 3,020억 8,300만 USD
  - 2023년: 약 2,904억 3,700만 USD
  - 2024년: 약 3,080억 3,000만 USD  
    → 부채 측면에서는 2023년 일부 감소한 후 2024년 재상승하는 모습을 확인할 수 있습니다.

- **주주자본(Stockholders’ Equity)**

  - 2022년: 약 506억 7,200만 USD
  - 2023년: 약 621억 4,600만 USD
  - 2024년: 약 569억 5,000만 USD  
    → 2023년에 자본이 증가한 후 2024년 다소 축소된 모습을 나타내고 있습니다.

- **매출(Revenue from Contract With Customer Excluding Assessed Tax)**

  - 2022년: 약 3,943억 2,800만 USD
  - 2023년: 약 3,832억 8,500만 USD
  - 2024년: 약 3,910억 3,500만 USD  
    → 매출은 큰 폭의 변화 없이 전체적으로 안정성을 유지하는 것으로 보입니다.

- **순이익(Net Income/Loss)**
  - 2022년: 약 998억 3,000만 USD
  - 2023년: 약 969억 9,500만 USD
  - 2024년: 약 937억 3,600만 USD  
    → 순이익 역시 소폭 감소하는 경향을 보이며, 수익성 측면에서는 다소 하락세임을 확인할 수 있습니다.

---

## 2. 재무 상태 분석

1. **자산 및 부채 구조**

   - 전체 자산 측면에서는 경미한 증가가 관찰되며, 이는 지속적인 자산 투자가 이루어지고 있음을 시사합니다.
   - 부채는 2023년 단기적으로 하락한 후 2024년에 다시 증가하는 모습을 보입니다. 부채와 자본의 비율 변동을 주의 깊게 관찰할 필요가 있으며, 이는 미래 재무 건전성과 투자 여력에 영향을 줄 수 있습니다.

2. **주주자본 변화**

   - 2023년에는 주주자본이 증가했으나, 2024년에 다소 축소되었습니다. 이는 자본 조달, 배당 정책 또는 자사주 매입 등 다양한 요인에 의해 영향을 받았을 가능성이 있습니다.
   - 주주자본의 증감은 기업의 내부자본 활용 및 재무 안정성에 중요한 지표이므로 추후 공시되는 경영진의 주석 분석을 참고하는 것이 필요합니다.

3. **매출 및 수익성**

   - 매출은 전반적으로 안정된 수준을 유지하고 있으며, 큰 변동 없이 지속되고 있습니다.
   - 그러나 순이익은 다소 감소하는 추세를 보여, 영업비용 증가나 마진 압박 등 수익성 개선을 위한 노력이 필요할 수 있음을 시사합니다.

4. **전반적 재무 건전성**
   - 자산, 부채, 주주자본 및 순이익 등 주요 지표에서 변동폭이 크지 않으며, 전반적으로 안정적인 재무 상태를 유지하는 것으로 판단됩니다.
   - 다만, 2024년 순이익 및 주주자본의 소폭 감소 추세는 단기적인 수익성 압박 혹은 재무 정책 변화 등을 반영할 수 있으므로, 향후 추세와 경영진의 대응 전략에 주의를 기울이는 것이 바람직합니다.

---

## 3. 결론

최근 보고된 수치에 따르면 Apple Inc.는 안정적인 총자산 규모와 일정 수준의 매출 성장을 기록하고 있으나, 순이익과 주주자본 측면에서는 약간의 하락세가 관찰됩니다. 이러한 수치는 경영 정책, 비용 관리, 시장 환경 등 다양한 요인에 기인할 수 있으므로, 추가 공시 및 경영진 주석 분석과 함께 장기적인 추세를 모니터링하는 것이 중요합니다.

본 보고서는 공개된 재무 데이터에 기반한 분석으로, 구체적인 투자 판단 및 전략 수립 시에는 보다 심도 있는 분석 및 전문가 의견을 종합하여 고려하시기 바랍니다.
```

보고서를 살펴보니, 주요 재무지표를 몇가지 나열해주고, 이어서 지표 추세를 바탕으로 재무 상태를 분석해주고 있습니다.

예전에는 재무제표의 각 항목이 뭔지 하나하나 공부하고, 복잡한 계산을 하는 게 참 어려웠는데요,

이제 그냥 데이터만 던져주면 AI가 다 해석해주니 정말 편해졌죠!

지금도 충분히 좋지만, 7강에서 처음에 생성했던 보고서처럼 개선할 점이 몇 가지 보이네요.

데이터를 단순히 나열하기보다, 더 깊이 있는 분석을 할 필요가 있습니다.

또 전체 요약을 먼저 제시하고, 세부 분석으로 이어지는 구조를 지정해주는 게 좋겠습니다.

이런 부분들은 지난번과 같이, 프롬프트 개선, 응답 형식 지정과 같은 방법을 통해 보완할 수 있을 겁니다.

## 요약

오늘 우리는:

1. 기본적 분석의 개념과 중요성에 대해 배웠습니다.
2. 그리고 재무제표 데이터를 가져오는 방법을 알아봤고요,
3. 수집한 재무제표 데이터를 정리하는 방법도 배웠습니다.
4. 마지막으로 OpenAI API를 활용해 간단한 기본 분석 보고서를 생성하는 방법까지 알아보았습니다.

다음 시간에는 더 고도화된 재무제표 분석 방법과 보다 심층적인 보고서를 생성하는 프롬프트 작성법에 대해 배워보도록 하겠습니다.

그럼 다음 시간에 만나요!
---

### 1️⃣ 기본적 분석의 개념

- 기본적 분석은 기업의 재무제표, 사업 모델, 경쟁력, 산업 환경 등을 분석해 내재가치를 평가하는 방법입니다.
    - 워렌 버핏이 주로 사용하는 분석 방법으로, 기업의 실제 가치를 평가하는 데 중점을 둡니다.
- 재무제표는 기본적 분석의 핵심 자료로, 기업의 재무 상태와 경영 성과를 보여줍니다.
    - 재무상태표: 기업이 보유한 자산, 부채, 자본을 보여줍니다.
    - 손익계산서: 기업의 매출, 비용, 이익을 보여줍니다.
    - 현금흐름표: 실제 현금의 유입과 유출을 보여줍니다.
- 재무제표는 분기별, 연간 단위로 공시되며, 공식 기관이나 포털 등에서 확인할 수 있습니다.
    - 한국 기업: 금융감독원 전자공시시스템(DART)
    - 미국 기업: 증권거래위원회(Securities and Exchange Commision, SEC)의 EDGAR(Electronic Data Gathering, Analysis, and Retrieval) 시스템
    - 기타 금융 포털: yahoo finance, 네이버페이 금융

### 2️⃣ 재무제표 데이터 가져오기

- 재무제표 데이터를 가져오기 위한 환경을 설정합니다.

```python
# 필요한 라이브러리 가져오기
import pandas as pd
import requests
import os
from pathlib import Path
from datetime import datetime, timedelta
from sec_cik_mapper import StockMapper
from dotenv import load_dotenv
from openai import OpenAI
```

```python
# .env 파일 로드하기
load_dotenv()

# 환경 변수 가져오기
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
USER_AGENT = os.getenv("USER_AGENT")  # SEC EDGAR API 사용 시 필요

openai_client = OpenAI(api_key=OPENAI_API_KEY)
```

```python
# 조회할 종목 지정하기
market = "ovs"  # 해외
stock_code = "AAPL"  # 종목코드

# 파일 경로 지정하기
root_path = Path(__vsc_ipynb_file__).parent
data_path = root_path / "data"  # 차트 데이터 경로
report_path = root_path / "report"  # 분석 보고서 경로

# 경로 생성하기
data_path.mkdir(parents=True, exist_ok=True)
report_path.mkdir(parents=True, exist_ok=True)

```

- SEC EDGAR API에서 원하는 기업의 CIK 코드를 통해 재무제표 데이터를 가져옵니다.

```python
# 종목코드를 SEC의 CIK 코드로 변환하기
stock_mapper = StockMapper()
cik = stock_mapper.ticker_to_cik[stock_code]

# API 요청을 위한 헤더 설정하기
HEADERS = {
    "User-Agent": USER_AGENT,
    "Accept-Encoding": "gzip, deflate",
    "Host": "data.sec.gov",
    "Connection": "keep-alive"
}

# SEC에서 재무제표 데이터 가져오기
url = f"https://data.sec.gov/api/xbrl/companyfacts/CIK{cik}.json"
response = requests.get(url, headers=HEADERS)
data = response.json()
```

<aside>
⚠️

**여기서 잠깐!**

- API의 User-Agent 헤더는 일반적으로 요청하는 사용자의 디바이스, 브라우저 환경 정보 등을 포함합니다.
    - 이 정보는 서버에서 과도한 요청에 대해 요청 거부, 차단 등의 조치를 취할 수 있게 합니다.
- SEC EDGAR의 경우 User-Agent를 "이름 (이메일)" 형식으로 작성할 것을 권장합니다.
    - 원활한 API 사용을 위해 `USER_AGENT` 환경 변수에 이름 (이메일)을 저장해두고 사용하는 것이 좋습니다.
</aside>

- 가져온 원본 데이터를 확인합니다.

```json
{
    "cik": 320193,
    "entityName": "Apple Inc.",
    "facts": {
        ...
        "us-gaap": {
            "AccountsPayable": {
                "label": "Accounts Payable",
                "description": "...",
                "units": {
                    "USD": [
                        {
                            "end": "2008-09-27",
                            "val": 5520000000,
                            "accn": "0001193125-09-153165",
                            "fy": 2009,
                            "fp": "Q3",
                            "form": "10-Q",
                            "filed": "2009-07-22"
                        },
                        ...
                    ]
                }
            },
            ...
        }
    }
}
```

<aside>
➕

**재무제표 데이터 구조**

- 미국 기업의 재무제표는 GAAP(Generally Accepted Accounting Principles)이라는 일반 회계 원칙을 따릅니다.
- EDGAR API에서는 이 기준을 따른 재무제표를 JSON 형식으로 받을 수 있습니다.
    - `entityName`: 기업명
    - `facts`: 재무정보가 포함된 객체
        - `us-gaap`: 미국 일반회계원칙에 따른 정보
            - `fy`: 회계연도(fiscal year)
            - `fp`: 회계기간(fiscal period)
            - `form`: 회계양식
                - “10-K”: 연간 보고서
                - “10-Q”: 분기 보고서
                - “10-K/A”: 연간 보고서 수정
</aside>

### 3️⃣ 연간 재무제표 데이터 추출하기

- 복잡한 JSON 구조에서 최근 3년간의 연간 재무제표 데이터만 추출합니다.

```python
# 기업명 가져오기
company_name = data["entityName"]
# 미국 회계기준 데이터 가져오기
us_gaap = data.get("facts", {}).get("us-gaap", {})

financial_data = []
existing_entries = set()
three_years_ago = datetime.now() - timedelta(days=3*365)

# 각 재무 항목별로 데이터 추출하기
for metric, details in us_gaap.items():
    for unit, entries in details["units"].items():
        for entry in entries:
            # 날짜 정보 가져오기
            end_date = entry.get("end", "")
            # 회계 연말 데이터만 선택하기
            if entry.get("fp", "") != "FY":
                continue

            # 최근 3년치 데이터만 활용하기
            formatted_end_date = datetime.strptime(end_date, "%Y-%m-%d")
            if formatted_end_date <= three_years_ago:
                continue

            # 중복 데이터 처리: 10-K/A가 있는 경우 덮어쓰기
            key = (end_date, metric)
            if key in existing_entries:
                financial_data.pop()
            existing_entries.add(key)

            financial_data.append({
                "Date": end_date,
                "Metric": metric,
                "Unit": unit,
                "Value": entry.get("val", "")
            })

# 데이터프레임으로 변환하고 CSV 파일로 저장하기
df = pd.DataFrame(financial_data)
df.to_csv(data_path / f"{stock_code}.csv", index=False)
```

- 추출 결과를 확인합니다.

```
         Date                        Metric Unit         Value
0  2022-09-24        AccountsPayableCurrent  USD  6.411500e+10
1  2023-09-30        AccountsPayableCurrent  USD  6.261100e+10
2  2024-09-28        AccountsPayableCurrent  USD  6.896000e+10
3  2022-09-24  AccountsReceivableNetCurrent  USD  2.818400e+10
4  2023-09-30  AccountsReceivableNetCurrent  USD  2.950800e+10
5  2024-09-28  AccountsReceivableNetCurrent  USD  3.341000e+10
6  2022-09-24     AccruedIncomeTaxesCurrent  USD  6.552000e+09
7  2023-09-30     AccruedIncomeTaxesCurrent  USD  8.819000e+09
8  2024-09-28     AccruedIncomeTaxesCurrent  USD  2.660100e+10
9  2022-09-24  AccruedIncomeTaxesNoncurrent  USD  1.665700e+10
...
```

### 4️⃣ AI를 활용한 기본 분석 보고서 생성하기

- AI 보고서 생성을 위한 프롬프트를 작성합니다.
    - 개발자 프롬프트 `prompt_fund_dev`에는 역할 부여, 보고서 형식을 포함합니다.
    - 사용자 프롬프트 `prompt_fund_user`에는 분석할 데이터를 JSON 형식으로 전달합니다.

```python
# 프롬프트 작성하기
prompt_fund_dev = f"""
너는 투자 분석가야. 다음 기업 {company_name}의 연간 사업보고서를 참고하여 이 기업의 재무 상태를 요약, 분석한 Markdown 형식의 보고서를 한국어로 출력해줘.
직접적인 투자 의견을 제시하는 것은 피하고, 기업의 최근 재무 상태 분석에 초점을 맞춰줘."""

prompt_fund_user = f"""
최근 3년간 사업보고서: {df.to_json(indent=4, force_ascii=False)}
"""
```

- OpenAI API를 호출합니다.

```python
# OpenAI API 호출하기
reasoning_effort = "low"
response = openai_client.chat.completions.create(
    model="o3-mini",
    messages=[
        {"role": "developer", "content": prompt_fund_dev},
        {"role": "user", "content": prompt_fund_user}
    ],
    reasoning_effort=reasoning_effort
)

# 응답 저장하기
with open(report_path / f"{stock_code}_v1.md", "w") as f:
    f.write(response.choices[0].message.content)

```

- 생성 결과를 확인합니다.

```markdown
아래는 최근 연간 사업보고서 데이터를 토대로 산출한 Apple Inc.의 재무 상태 요약 및 분석 보고서입니다. 이 보고서는 투자 조언이 아닌, 공개된 수치와 주요 재무지표 변동에 기반한 분석 내용임을 참고하시기 바랍니다.

---

## 1. 주요 재무지표 개요

- **자산(Assets)**
  - 2022년: 약 3,527억 5,500만 USD
  - 2023년: 약 3,525억 8,300만 USD
  - 2024년: 약 3,649억 8,000만 USD  
  → 전체 자산은 2022년 대비 2024년에 소폭 증가하는 추세를 보입니다.

- **부채(Liabilities)**
  - 2022년: 약 3,020억 8,300만 USD
  - 2023년: 약 2,904억 3,700만 USD
  - 2024년: 약 3,080억 3,000만 USD  
  → 부채 측면에서는 2023년 일부 감소한 후 2024년 재상승하는 모습을 확인할 수 있습니다.

- **주주자본(Stockholders’ Equity)**
  - 2022년: 약 506억 7,200만 USD
  - 2023년: 약 621억 4,600만 USD
  - 2024년: 약 569억 5,000만 USD  
  → 2023년에 자본이 증가한 후 2024년 다소 축소된 모습을 나타내고 있습니다.

- **매출(Revenue from Contract With Customer Excluding Assessed Tax)**
  - 2022년: 약 3,943억 2,800만 USD
  - 2023년: 약 3,832억 8,500만 USD
  - 2024년: 약 3,910억 3,500만 USD  
  → 매출은 큰 폭의 변화 없이 전체적으로 안정성을 유지하는 것으로 보입니다.

- **순이익(Net Income/Loss)**
  - 2022년: 약 998억 3,000만 USD
  - 2023년: 약 969억 9,500만 USD
  - 2024년: 약 937억 3,600만 USD  
  → 순이익 역시 소폭 감소하는 경향을 보이며, 수익성 측면에서는 다소 하락세임을 확인할 수 있습니다.

---

## 2. 재무 상태 분석

1. **자산 및 부채 구조**  
   - 전체 자산 측면에서는 경미한 증가가 관찰되며, 이는 지속적인 자산 투자가 이루어지고 있음을 시사합니다.  
   - 부채는 2023년 단기적으로 하락한 후 2024년에 다시 증가하는 모습을 보입니다. 부채와 자본의 비율 변동을 주의 깊게 관찰할 필요가 있으며, 이는 미래 재무 건전성과 투자 여력에 영향을 줄 수 있습니다.

2. **주주자본 변화**  
   - 2023년에는 주주자본이 증가했으나, 2024년에 다소 축소되었습니다. 이는 자본 조달, 배당 정책 또는 자사주 매입 등 다양한 요인에 의해 영향을 받았을 가능성이 있습니다.  
   - 주주자본의 증감은 기업의 내부자본 활용 및 재무 안정성에 중요한 지표이므로 추후 공시되는 경영진의 주석 분석을 참고하는 것이 필요합니다.

3. **매출 및 수익성**  
   - 매출은 전반적으로 안정된 수준을 유지하고 있으며, 큰 변동 없이 지속되고 있습니다.  
   - 그러나 순이익은 다소 감소하는 추세를 보여, 영업비용 증가나 마진 압박 등 수익성 개선을 위한 노력이 필요할 수 있음을 시사합니다.

4. **전반적 재무 건전성**  
   - 자산, 부채, 주주자본 및 순이익 등 주요 지표에서 변동폭이 크지 않으며, 전반적으로 안정적인 재무 상태를 유지하는 것으로 판단됩니다.  
   - 다만, 2024년 순이익 및 주주자본의 소폭 감소 추세는 단기적인 수익성 압박 혹은 재무 정책 변화 등을 반영할 수 있으므로, 향후 추세와 경영진의 대응 전략에 주의를 기울이는 것이 바람직합니다.

---

## 3. 결론

최근 보고된 수치에 따르면 Apple Inc.는 안정적인 총자산 규모와 일정 수준의 매출 성장을 기록하고 있으나, 순이익과 주주자본 측면에서는 약간의 하락세가 관찰됩니다. 이러한 수치는 경영 정책, 비용 관리, 시장 환경 등 다양한 요인에 기인할 수 있으므로, 추가 공시 및 경영진 주석 분석과 함께 장기적인 추세를 모니터링하는 것이 중요합니다.

본 보고서는 공개된 재무 데이터에 기반한 분석으로, 구체적인 투자 판단 및 전략 수립 시에는 보다 심도 있는 분석 및 전문가 의견을 종합하여 고려하시기 바랍니다.
```

- 생성 결과를 검토합니다.
    - 데이터를 단순히 나열하는 것을 넘어, 더 깊이 있는 분석을 하는 게 좋겠습니다.
    - 전체 요약을 먼저 제시하고, 세부 분석으로 이어지는 구조를 지정해주는 게 좋겠습니다.