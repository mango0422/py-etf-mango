안녕하세요, 여러분! 반갑습니다.
지난 시간에는 API 문서를 보고 요청을 보내서 토큰을 받아보았고, 우리가 어떤 데이터를 조회해야 하는지도 알아보았는데요.

이제 드디어 실제 주식 데이터를 조회해보도록 하겠습니다.

애플 일봉 데이터를 한번 가져와 볼게요. 한국투자증권 API 중에서, “해외주식 기간별 시세” 항목을 사용해야 합니다.

지난 시간에 access token(액세스 토큰)을 발급받았던 것처럼, 이번에도 문서를 잘 보고 우리가 원하는 정보를 필요한 양식에 맞춰 요청을 보내면 됩니다.

문서를 같이 보면서 코드를 어떻게 작성해야 하는지 하나씩 알아보도록 하겠습니다.

- **API _ [해외주식 기간별시세](https://apiportal.koreainvestment.com/apiservice/apiservice-oversea-stock-quotations#L_0e9fb2ba-bbac-4735-925a-a35e08c9a790) (해외)**
    
    ![스크린샷 2025-03-28 오전 11.26.18.png](attachment:c25b6159-3333-43e0-9e7d-315f7081d073:스크린샷_2025-03-28_오전_11.26.18.png)
    
    ![스크린샷 2025-03-28 오전 11.27.26.png](attachment:93c4c7ca-fc5a-4e80-99fe-c4939fbddc28:스크린샷_2025-03-28_오전_11.27.26.png)
    
    ![스크린샷 2025-03-28 오전 11.27.42.png](attachment:3967e67d-fde5-411e-9492-880c61075003:스크린샷_2025-03-28_오전_11.27.42.png)
    

먼저 문서에 나오는 몇 가지 용어들을 살펴볼게요.
method(메서드)라는 것이 나오는데, HTTP(에이치 티 티 피) 통신에서 메서드는 REST API에서 서버가 수행할 동작을 요청하는 방법입니다.
대표적으로 GET(겟), POST(포스트), PUT(풋), DELETE(딜리트) 이렇게 4가지 유형이 있는데요, 보통 정보를 가져올 때는 GET을, 정보를 보낼 때는 POST를 사용합니다.

처음 보시면 생소하시겠지만, 문서의 안내를 그대로 따라하시면 쉽게 데이터를 조회하실 수 있어요.

여기서는 GET 메서드를 사용하네요.

domain은 한국투자증권 서비스를 사용하기 위한 기본 주소이고,

url은 한국투자증권 서비스 중에서도 특정 기능을 사용하기 위해 domain 뒤에 덧붙이는 주소입니다.

그리고 Request(리퀘스트)와 Response라는 항목이 있는데요,
Request는 사용자가 요청을 보낼 때 지켜야 할 형식을 의미합니다.

여기에는 header(헤더)와 query parameter(쿼리 파라미터)가 정해져 있네요.

header에는 지난 시간에 본 것과 같이 접근 토큰, 고객 타입 등 기본 정보나 설정 값이 들어가고,
query parameter에는 시장 종류, 종목 등 내가 원하는 정보에 대한 구체적인 내용이 들어갑니다.

여기서 잠깐, query parameter와 지난 시간에 봤던 body(바디)와는 어떤 차이가 있을까요?

보통 query parameter는 GET 요청에서 간단한 정보를 전달할 때 사용하고,

body는 POST나 PUT 요청에서 상대적으로 큰 데이터를 전송할 때 사용한다는 점 참고해주시면 좋겠습니다!

Response는 말 그대로 서버가 응답을 보내는 형식을 의미하는데,

API 응답이 온 다음에, 그 데이터를 분석할 때 사용할 수 있습니다.

- 코드
    
    ```python
    PATH = "uapi/overseas-price/v1/quotations/dailyprice"
    URL = f"{KIS_URL_BASE}/{PATH}"
    
    # 기존에 발급받은 정보 사용
    headers = {
        'content-type': 'application/json',
        'authorization': f'Bearer {KIS_ACCESS_TOKEN}',  
        'appkey': KIS_APP_KEY, 
        'appsecret': KIS_APP_SECRET, 
        'tr_id': 'HHDFS76240000', 
        'custtype': 'P' # 고객 타입
    }
    
    params = {
        "AUTH": "",  # 기본 값 (Null)
        "EXCD": "NAS",  # 거래소 코드 (예: 'NAS', 'NYS')
        "SYMB": "AAPL",  # 종목 코드 (예: 'TSLA')
        "GUBN": "0",  # 조회 구분 (0: 일, 1: 주, 2: 월)
        "BYMD": "",  # 조회 기준 일자: 한 번 호출에 이 날까지 100건 조회
        "MODP": "1",  # 수정주가 반영 여부 (0: 미반영, 1: 반영)
    }
    
    response = requests.get(URL, 
                            headers=headers, params=params)
    response_data = response.json()
    ```
    

자, 이제 실제 파이썬 코드를 작성해보도록 하겠습니다.
먼저 요청을 보낼 전체 주소가 담긴 URL을 만들어야 하는데요,

domain에 특정 기능 url 경로를 붙여서 하나의 완성된 URL 주소를 만들어 변수에 저장합니다.

이때 domain은 자주 사용되기 때문에 환경 변수에 저장해두면 편리합니다.

다음으로 header를 딕셔너리 형태로 만들어줍니다.

API 문서를 보시면 Required 칸에 Y라고 표시된 정보들은 필수로 넣어야 하는 정보들이에요.

이 정보들이 빠지면 응답을 받을 수 없으니 꼭 포함시켜주셔야 해요.

content-type(콘텐트 타입)은 문서에 적힌 대로 넣고,
authorization(오쏘라이제이션), appkey(앱 키), appsecret(앱 시크릿)에는 지난 시간에 발급받은 토큰과 원래 가지고 있던 appkey, appsecret을 넣어줍니다.
tr_id(티알 아이디)도 문서에 적힌 대로 넣고,
마지막 고객 타입은(custtype) 우리가 개인 투자자이므로 'P'를 넣어주시면 됩니다.

이제 파라미터를 채워볼게요. 쿼리 파라미터를 통해 우리가 원하는 데이터를 지정하게 됩니다.
이것도 마찬가지로 딕셔너리 형태로 만들면 됩니다.

각각의 항목을 살펴보면,

사용자권한정보는 문서에 적힌대로 비워두시면 됩니다.
거래소 코드는 나스닥 거래소의 애플 주식을 조회할 예정이므로 “NAS” (엔 에이 에스) 를 입력해주겠습니다.
종목코드에는 애플의 종목코드인 “AAPL” (에이-에이-피-엘)을 입력해주면 되겠죠.

기업별 종목 코드는 인터넷에 검색하면 금방 찾을 수 있으니 참고해주세요!

일/주/월구분에는 저희는 일봉을 볼 것이기 때문에 일에 해당하는 “0”을 채워줄게요.

조회기준일자는 공란으로 두어 오늘 날짜로 설정해보겠습니다. 이렇게 하면 오늘로부터 100건의 데이터를 가져오게 됩니다.
수정주가반영여부는 “1”로 두어 수정주가를 반영한 가격으로 조회 하겠습니다.
여기서 잠깐, 수정주가라는 게 뭘까요?

기업이 주식 분할을 하거나, 배당금 지급, 유상 증자 등의 활동을 하면 한 주당 가격에 변동이 생겨요.

예를 들어, 만 원 짜리 주식을 1 대 2로 분할 하면, 한 주 당 가격은 5천원이 되는 거죠.

이때, 분할 전의 가격들도 같은 계산을 적용해야 과거 주식의 가치도 정확하게 비교할 수 있겠죠?

갑자기 회사 전체의 가치가 절반이 된 건 아니니까요.

수정 주가 반영을 하면 이렇게 계산된 데이터를 조회하게 됩니다.

참고로, 우리가 평소에 자주 보는 증권 서비스의 차트에서는 대부분 이 수정주가가 반영된 가격을 표시합니다.

자, 이렇게 필요한 내용을 모두 준비했습니다.

이제 requests(리퀘스츠) 라이브러리를 사용해서, 준비한 URL 주소에 header와 parameter를 get 메서드로 보내보도록 하겠습니다.

- 코드 결과
    
    ```python
    pprint.pprint(response_data)
    ```
    
    ```python
    {'msg1': '정상처리 되었습니다.',
     'msg_cd': 'MCA00000',
     'output1': {'nrec': '100', 'rsym': 'DNASAAPL', 'zdiv': '4'},
     'output2': [{'clos': '223.8500',
                  'diff': '2.3200',
                  'high': '224.9900',
                  'low': '220.5601',
                  'open': '221.3900',
                  'pask': '223.5000',
                  'pbid': '223.2000',
                  'rate': '+1.05',
                  'sign': '2',
                  'tamt': '8285698351',
                  'tvol': '37094774',
                  'vask': '11',
                  'vbid': '25',
                  'xymd': '20250327'},
                 {'clos': '221.5300',
                  'diff': '2.2200',
                  'high': '225.0200',
                  'low': '220.4700',
                  'open': '223.5100',
                  'pask': '221.5300',
                  'pbid': '221.0100',
                  'rate': '-0.99',
    ...
                  'vask': '100',
                  'vbid': '300',
                  'xymd': '20241031'}],
     'rt_cd': '0'}
    ```
    

자, 실행해보면, 응답 데이터는 json(제이슨) 형식으로 오는데요,
json 응답 데이터는 응답 객체 안에 key-value(키, 밸류) 쌍이 있는 구조입니다.
json() 메서드를 사용해, 이걸 파이썬에서 딕셔너리로 사용할 수 있도록 변환해줍니다.

프린트해서 확인해보니 일봉 데이터가 문서에 나온 response 형식대로 잘 들어온 것을 확인할 수 있네요!

문서를 보시면 우리가 원하는 시가, 최고가, 최저가, 종가 등의 값들은 output2(아웃풋 투) 객체에 저장되어 있어요.
output2만 따로 데이터프레임으로 변환해서 행과 열이 있는 표 형태로 사용하겠습니다.

- 코드
    
    ```python
    params = {
        "AUTH": "",  # 기본 값 (Null)
        "EXCD": "NAS",  # 거래소 코드
        "SYMB": "AAPL",  # 종목 코드 
        "GUBN": "0",  # 조회 구분 
        "BYMD": "20241030",  # 조회 기준 일자
        "MODP": "1",  # 수정주가 반영 여부 
    }
    
    response = requests.get(URL, 
                            headers=headers, params=params)
    response_data = response.json()
    
    df2 = pd.DataFrame(response_data["output2"])
    df2["datetime"] = pd.to_datetime(df2["xymd"],
                                     format="%Y%m%d")
    
    # 필요한 컬럼만 선택하고 이름 변경
    df2.rename(
        columns={
            "open": "open",
            "high": "high",
            "low": "low",
            "clos": "close",
            "tvol": "volume",
        },
        inplace=True,
    )
    
    df2 = df2[
        ["datetime", "open", "high", "low", "close", "volume"]
        ]
    df = pd.concat([df, df2])
    ```
    
    ```python
         datetime      open      high       low     close    volume
    0  2025-03-27  221.3900  224.9900  220.5601  223.8500  37094774
    1  2025-03-26  223.5100  225.0200  220.4700  221.5300  34532656
    2  2025-03-25  220.7700  224.1000  220.0800  223.7500  34493583
    3  2025-03-24  221.0000  221.4800  218.5800  220.7300  44299483
    4  2025-03-21  211.5600  218.8400  211.2800  218.2700  94127768
    ..        ...       ...       ...       ...       ...       ...
    95 2024-11-06  222.1212  225.5686  220.7043  222.2310  54561121
    96 2024-11-05  221.3080  223.4583  220.6544  222.9593  28111338
    97 2024-11-04  220.5048  222.3008  219.2276  221.5225  44944468
    98 2024-11-01  220.4798  224.8552  219.7863  222.4205  65276741
    99 2024-10-31  228.8364  229.3253  224.8751  225.4139  64370086
    
    [100 rows x 6 columns]
    ```
    

문서를 참고해서 API를 통해 받은 데이터 중 우리가 필요한 항목들을 찾고,

각 컬럼명을 주식에서 많이 사용하는 OHLCV (오-에이치-엘-씨-브이)의 항목명으로 바꿔줄게요.

DataFrame의 rename 메서드를 이용하면 항목명을 바꿔줄 수 있습니다!

그리고 차트 구성에 필요한 컬럼만 남겨주도록 하겠습니다.

출력을 통해 확인해보면 거래 일자, open, high, low, close, volume으로 잘 나오는 것을 볼 수 있네요.

그리고 위에서 언급한대로 100개의 데이터를 가져오는 것도 확인할 수 있습니다.

```python
params = {
    "AUTH": "",  # 기본 값 (Null)
    "EXCD": "NAS",  # 거래소 코드 (예: 'NAS', 'NYS')
    "SYMB": "AAPL",  # 종목 코드 (예: 'TSLA')
    "GUBN": "0",  # 조회 구분 (0: 일, 1: 주, 2: 월)
    "BYMD": "20241031",  # 조회 기준 일자: 한 번 호출에 이 날까지 100건 조회
    "MODP": "1",  # 수정주가 반영 여부 (0: 미반영, 1: 반영)
}

response = requests.get(URL, 
                        headers=headers, params=params)
response_data = response.json()

df2 = pd.DataFrame(response_data["output2"])
df2["datetime"] = pd.to_datetime(df2["xymd"], format="%Y%m%d")
# 필요한 컬럼만 선택하고 이름 변경
df2.rename(
    columns={
        "open": "open",
        "high": "high",
        "low": "low",
        "clos": "close",
        "tvol": "volume",
    },
    inplace=True,
)

df2 = df2[["datetime", "open", "high", "low", "close", "volume"]]
df = pd.concat([df, df2])
df
```

만약 데이터를 100건보다 더 많이 얻고 싶을 땐 어떻게 할까요?

마지막 데이터 이전 날짜 기준으로 데이터를 한 번 더 조회하고 이어붙여주면 됩니다.

API 호출을 할 때 쿼리 파라미터의 기준 일자 항목을 수정해서 데이터를 조회하고,

pandas의 concat을 사용하면 기존 데이터프레임과 새로 조회한 데이터프레임을 연결할 수 있습니다.

```sql
# 날짜 오름차순으로 정렬
df = df.sort_values('datetime', ascending=True)
df

file_path = f"AAPL_ohlcv.csv"
df.to_csv(file_path, 
          index=False, encoding="utf-8-sig")
```

마지막으로 데이터를 오름차순으로 정렬하고, csv파일로 저장하겠습니다.

그러면 이후에 차트를 그리는 등 데이터를 사용할 때, 다시 조회 요청을 보낼 필요 없이 편리하게 사용할 수 있겠죠?

비슷한 방법으로 문서를 참고해서,

국내 주식 일봉 및 주봉 데이터,

해외 주식 분봉 데이터까지 가져올 수 있답니다!

(분량이 너무 많아서, 자료화면 한 번씩만 쓱 보여주고 넘어가기)

이렇게 오늘은 실제로 주식 데이터를 조회하는 방법을 배워보았는데요,
다음 시간에는 이 데이터를 가지고 차트를 그리는 방법을 알아보도록 하겠습니다.
그럼 다음 시간에 뵙겠습니다!
---
### 1️⃣ HTTP 통신과 REST API

- HTTP 통신은 클라이언트와 서버 간 데이터를 주고받는 프로토콜입니다.
- REST API는 HTTP 메서드를 사용해 서버에 요청을 보내고 응답을 받는 방식입니다.
- API 요청은 domain과 url로 구성된 주소로 전송됩니다.
    - domain은 서비스의 기본 주소입니다.
    - url은 특정 기능을 사용하기 위해 domain 뒤에 추가하는 경로입니다.

<aside>
➕ **HTTP 메서드의 종류**

- GET: 서버에서 리소스를 가져옵니다. (데이터 조회)
- POST: 새로운 리소스를 생성합니다. (데이터 생성)
- PUT: 기존 리소스를 전체 교체합니다. (데이터 수정)
- PATCH: 리소스의 일부만 변경합니다. (데이터 수정)
- DELETE: 리소스를 삭제합니다. (데이터 삭제)
</aside>

<aside>
⚠️ **여기서 잠깐!**

- PUT과 PATCH 모두 데이터 수정에 사용되지만 차이점이 있습니다.
    - PUT은 리소스의 전체를 교체하고, 요청에 없는 필드는 기본 값으로 초기화됩니다.
    - PATCH는 리소스의 일부분만 변경하고, 요청에 포함된 필드만 업데이트됩니다.
- REST API 설계 시 메서드를 올바르게 선택하는 것이 중요합니다.
</aside>

### 2️⃣ API 요청하기

- API 요청은 header와 parameter로 구성됩니다.
    - header는 요청에 대한 기본 정보와 설정을 포함합니다.
    - parameter는 조회하고자 하는 데이터의 구체적인 조건을 지정합니다.

```python
# API 요청을 위한 URL 생성하기
PATH = "uapi/overseas-price/v1/quotations/dailyprice"
URL = f"{KIS_URL_BASE}/{PATH}"
```

```python
# API 요청에 필요한 헤더 설정하기
headers = {
    'content-type': 'application/json',
    'authorization': f'Bearer {KIS_ACCESS_TOKEN}',
    'appkey': KIS_APP_KEY,
    'appsecret': KIS_APP_SECRET,
    'tr_id': 'HHDFS76240000',
    'custtype': 'P'
}
```

```python
# API 요청에 필요한 파라미터 설정하기
params = {
    "AUTH": "",
    "EXCD": "NAS",
    "SYMB": "AAPL",
    "GUBN": "0",
    "BYMD": "",
    "MODP": "1",
}
```

<aside>
⚠️ **여기서 잠깐!**

- query parameter와 body는 데이터 전달 방식이 다릅니다.
- query parameter는 GET 요청에서 간단한 정보를 전달할 때 사용합니다.
- body는 POST나 PUT 요청에서 큰 데이터를 전송할 때 사용합니다.
</aside>

### 3️⃣API 응답받기

- API 응답은 서버가 정해진 형식으로 데이터를 반환합니다.
    - 응답 데이터는 주로 JSON 형식으로 전달됩니다.
    - JSON은 key-value 쌍으로 구성된 데이터 형식입니다.
- requests 라이브러리로 API 요청을 보내고 응답을 받습니다.

```python
# API 요청 보내고 응답 받기
response = requests.get(URL, headers=headers, params=params)
response_data = response.json()
```

- 응답 데이터를 pandas DataFrame으로 변환해 분석할 수 있습니다.

```python
# 응답 데이터를 DataFrame으로 변환하기
df = pd.DataFrame(response_data["output2"])
```

- DataFrame은 행과 열로 구성된 표 형태의 데이터 구조입니다.
    - 각 열은 거래 일자, 시각, 가격, 거래량 등의 정보를 포함합니다.
    - DataFrame을 CSV 파일로 저장해 추후 분석에 활용할 수 있습니다.
    - 조회한 데이터 중 필요한 데이터만 남겨서 사용할 수 있습니다.
    - 조회한 데이터 중 항목의 이름을 사용하기 편하게 변경해도 됩니다.