안녕하세요, 여러분! 반갑습니다.
지난 시간까지 주식 데이터를 조회하고 차트로 그리는 연습을 해보았는데요, 오늘은 이동평균선이라는 새로운 지표를 소개해드리고, 이 값을 데이터에 추가해서 그래프에도 표시해보도록 하겠습니다.

지난 강의에서 OHLCV(오 에이치 엘 씨 브이) 데이터가 무엇인지, 그리고 이 데이터로 주식 차트의 기본 단위인 '캔들'을 만든다는 것까지 설명드렸었는데요,
오늘 배울 이동평균선은 주식 차트에서 일정 기간의 평균 주가, 그 중에서도 종가의 평균을 선으로 나타낸 것입니다.

좀 더 자세히 설명드리면, 이전 몇 개의 캔들의 평균 종가를 계산해서 이를 그래프에 연속된 선으로 그리는 건데요,
예를 들어 5일 이동평균선은 이렇게 구합니다.

첫째 날부터 다섯째 날까지의 종가가 각각 100원, 110원, 120원, 130원, 140원이라고 할 때,
다섯째 날의 5일 이동평균은 이 다섯 개의 값을 더해서 5로 나눈 120원이 되는 거죠.
그 다음 날 종가가 150원이라면, 둘째 날부터 여섯째 날까지의 평균인 130원이 여섯째 날의 이동평균이 됩니다.

| 날짜 | 종가 (stck_clpr) | 5일 이동평균 (ma5)                    |
| ---- | ---------------- | ------------------------------------- |
| 1일  | 100              | NaN                                   |
| 2일  | 110              | NaN                                   |
| 3일  | 120              | NaN                                   |
| 4일  | 130              | NaN                                   |
| 5일  | 140              | **120.0** → (100+110+120+130+140) / 5 |
| 6일  | 150              | **130.0** → (110+120+130+140+150) / 5 |
| 7일  | 160              | **140.0** → (120+130+140+150+160) / 5 |

이동평균선은 보통 단기로는 5일, 중기로는 20일, 60일, 장기로는 120일의 평균을 많이 사용하는데요,
이렇게 하면 어떤 장점이 있을까요?

가장 큰 장점은 주가의 추세를 한눈에 파악할 수 있다는 것입니다.
짧은 기간 동안 요동치는 가격 변동을 평탄화해주기 때문인데요,
또한 단기와 장기의 주가 흐름을 비교하면서 앞으로의 상승과 하락을 예측하는 데도 활용할 수 있습니다.
이 부분은 나중에 기술적 분석을 배울 때 좀 더 자세히 설명드리도록 하겠습니다.

자, 이제 실제로 우리가 가진 ohlcv 데이터에 이동평균선을 추가해보도록 하겠습니다.
먼저 이전에 저장했던 일봉 데이터 CSV 파일을 데이터프레임으로 불러오겠습니다.

- 코드

  ```python
  # 주가 데이터 파일 읽기
  df = pd.read_csv(f"AAPL_ohlcv.csv")

  # 이동평균선 계산
  df['ma5']=df['close'].rolling(5).mean()
  df['ma20']=df['close'].rolling(20).mean()
  df['ma60']=df['close'].rolling(60).mean()
  df['ma120']=df['close'].rolling(120).mean()

  df.to_csv(f'AAPL_ohlcv_ma.csv', index=False)
  df[["datetime", "ma5", "ma20", "ma60", "ma120"]]
  ```

이제 이동평균선을 계산할 텐데요,
pandas 라이브러리의 rolling(롤링)이라는 메서드를 사용합니다.
이 메서드는 이동하는 창, 윈도우를 만들어서 데이터를 그룹화하는데요,
괄호 안에 창의 크기를 입력하면 데이터프레임을 순회하면서 현재 행 이전으로 창 크기만큼의 데이터를 묶어줍니다.

여기에 mean(민) 메서드를 함께 사용하면 그룹화된 데이터의 평균을 구할 수 있는데요,
이렇게 해서 5일, 20일, 60일, 120일 이동평균선을 모두 구해보도록 하겠습니다.

계산이 끝나면 이동평균선이 추가된 데이터프레임을 CSV 파일로 저장합니다.
파일을 열어보시면 기존 데이터에 이동평균값들이 잘 추가된 것을 확인하실 수 있을 거예요.

- 결과
  ![5강_ma_csv.png](attachment:3f7eca0e-d37c-4c5a-84d4-0bab19f96a92:5강_ma_csv.png)

이제 지난 시간에 그린 차트에 이 이동평균선들을 추가해보도록 하겠습니다.
기본적인 차트 그리기는 지난 시간과 동일한데요,
여기에 이동평균선을 추가하기 위해 add_trace() 메서드를 한 번 더 사용합니다.

go.Scatter(지오 점 스캐터)로 선그래프 객체를 생성하는데요,
x좌표에는 주식 거래 날짜를,
y좌표에는 앞서 구한 이동평균값을 넣어줍니다.
각 선마다 다른 색상을 설정하고 이름도 붙여주면,
캔들차트 위에 이동평균선이 깔끔하게 표시되는 것을 확인하실 수 있습니다.

- 코드

  ```python
  def candlestick_chart_with_ma(stock_code: str):
      df = pd.read_csv(f"{stock_code}_ohlcv_ma.csv")
      df = df.sort_values('datetime', ascending=True)
      df["datetime"] = pd.to_datetime(
                        df["datetime"]).dt.strftime("%y-%m-%d")

      # 2개의 subplot 생성, 2행으로 배치 (캔들차트, 거래량)
      # 2개의 subplot 생성 (캔들차트, 거래량)
      fig = make_subplots(rows=2, cols=1, shared_xaxes=True,
                  vertical_spacing=0.1,
                  subplot_titles=('AAPL 주가', '거래량'),
                  row_heights=[0.7, 0.3])

      fig.update_layout(
          font=dict(size=14),          # 전체 기본 폰트 크기
          legend=dict(font=dict(size=18))  # 범례 폰트 크기
      )

      # 하단 range slider 제거
      fig.update(layout_xaxis_rangeslider_visible = False)

      # 캔들스틱 차트 추가 (첫번째 subplot)
      fig.add_trace(go.Candlestick(
          x=df['datetime'],
          open=df['open'],
          high=df['high'],
          low=df['low'],
          close=df['close'],
          name='AAPL',
          increasing_line_color='red',
          decreasing_line_color='blue'
      ), row=1, col=1)

      # 가격 변화에 따른 거래량 막대 색상 설정
      # 가격 변화 계산: 종가 - 시가
      df['change'] = df['close'] - df['open']
      # 상승 시 빨간색
      df.loc[df['change'] >= 0,'VolumeColor'] = 'red'
      # 하락 시 파랑색
      df.loc[df['change'] < 0,'VolumeColor'] = 'blue'
      df[['change','VolumeColor']]

      # 거래량 바 차트 추가 (두번째 subplot)
      fig.add_trace(go.Bar(
                      x = df['datetime'],
                      y = df['volume'],
                      marker = dict(color = df['VolumeColor']),
                      name = '거래량'
                  ), row = 2, col = 1)

      # x축 타입을 category로 설정
      fig.update_xaxes(type = "category", dtick=15)

      fig.update_layout(
          title='애플(AAPL) 주가 차트',
          yaxis_title='주가 (USD)',
          yaxis2_title='거래량',
          xaxis_rangeslider_visible = False,
          height=600,
      )
      fig.add_trace(
          go.Scatter(x=df['datetime'], y=df['ma20'],
                  line=dict(color="#e8d887"),
                      name='MA20'),
          row=1, col=1
      )

      fig.add_trace(
          go.Scatter(x=df['datetime'], y=df['ma60'],
                  line=dict(color="#73ad8a"),
                      name='MA60'),
          row=1, col=1
      )

      fig.add_trace(
          go.Scatter(x=df['datetime'], y=df['ma120'],
                  line=dict(color="#8b8b8b"),
                      name='MA120'),
          row=1, col=1
      )

      return fig

  chart = candlestick_chart_with_ma("AAPL")
  # 차트 표시
  chart.show()
  ```

자, 이렇게 해서 우리는 파이썬 코드로 주가 데이터를 가져오고, 간단한 지표를 계산하고, 이를 차트에 그리는 것까지 모두 해보았는데요!
이제 우리가 주식 거래 프로그램에서 보던 것들을 코드로 직접 구현할 수 있게 되었습니다.

마무리하기 전에, 혹시 macd(엠 에이 씨 디), rsi(알 에스 아이), 볼린저 밴드 같은 지표들을 사용하고 계신 분들은 그런 것도 파이썬으로 할 수 있는지 궁금하실 거예요. 그런 분들은 pandas_ta(판다스 티에이)라는 라이브러리를 쓰면 쉽게 계산할 수 있으니 참고해주세요!

앞으로 이것들을 활용해서 할 수 있는 게 정말 많아질 텐데요,
다음 시간부터는 더욱 흥미로운 내용들을 다뤄보도록 하겠습니다!
그럼 다음 시간에 만나요!

---

### 1️⃣ 이동평균선 이해하기

- 이동평균선은 일정 기간 동안의 평균 종가를 선으로 표현한 지표입니다.
  - 이전 n개 캔들의 종가 평균을 연속적으로 계산합니다.
  - 단기(5일), 중기(20일, 60일), 장기(120일) 이동평균선을 주로 사용합니다.
- 이동평균선은 주가의 추세를 파악하는 데 도움을 줍니다.
  - 단기 가격 변동을 평탄화하여 전체적인 흐름을 보여줍니다.
  - 단기와 장기 이동평균선을 비교하여 향후 방향을 예측할 수 있습니다.

### 2️⃣ 이동평균선 계산하기

```python
# 주가 데이터 파일 읽고 정렬하기
df = pd.read_csv(f"AAPL_ohlcv.csv")

# 이동평균선 계산하기
df['ma5']=df['close'].rolling(5).mean()
df['ma20']=df['close'].rolling(20).mean()
df['ma60']=df['close'].rolling(60).mean()
df['ma120']=df['close'].rolling(120).mean()

df.to_csv(f'AAPL_ohlcv_ma.csv', index=False)
```

- pandas의 rolling 메서드
  - rolling은 데이터를 지정된 크기의 윈도우로 그룹화합니다.
  - 현재 행을 기준으로 이전 데이터를 묶어서 처리합니다.
  - mean 메서드와 함께 사용하여 이동평균을 계산합니다.
  - 슬라이딩 윈도우 방식으로 동작하며, 한번의 순회만으로 평균을 계산 및 저장합니다.

<aside>
⚠️ **여기서 잠깐!**

- 이동평균선 계산 시 지정된 크기가 n 일때, 초기 n-1개의 데이터는 평균을 계산할 수 없습니다.
- 이 경우 NaN(Not a Number) 값으로 표시됩니다.
- 데이터 분석 시 이러한 결측값 처리에 주의해야 합니다.
</aside>

<aside>
➕ **주가 흐름 파악을 위한 보조 지표**

- 주가 흐름 보조 지표
  - MACD: 추세의 방향과 강도 파악
  - RSI: 과매수 / 과매도 상태 판단
  - 볼린저 밴드: 변동성 분석 및 가격 범위 확인
- 위의 보조 지표들은 pandas_ta 라이브러리를 활용해 파이썬으로 쉽게 계산할 수 있습니다.
- 이러한 지표들은 주가의 추세와 변동성을 분석하는 데 활용됩니다.
</aside>
