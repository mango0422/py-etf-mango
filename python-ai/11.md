# 11강: 주문 넣는 방법

안녕하세요, 여러분! 반갑습니다.

지난 시간까지 우리는 파이썬과 AI를 활용해 관련 뉴스를 자동으로 수집하고 분석시키는 방법을 배웠습니다.

오늘은 파이썬으로 실제 주문을 실행하는 연습을 해보도록 하겠습니다!

## 필요한 기본 설정

먼저 필요한 라이브러리와 환경 변수 설정부터 간단히 살펴보겠습니다.

- 코드 (초기 환경 변수 초기화 및 접근 토큰 발급)
    
    ```python
    from datetime import datetime, timedelta
    import pandas as pd
    import requests
    import json
    import yaml
    import time
    
    import os
    from dotenv import load_dotenv
    
    load_dotenv()
    
    # 환경 변수에서 필요한 값들 가져오기
    KIS_URL_BASE = os.getenv("KIS_URL_BASE")
    KIS_APP_KEY = os.getenv("KIS_APP_KEY") 
    KIS_APP_SECRET = os.getenv("KIS_APP_SECRET")
    ```
    
    ```python
    # 접근 토큰 발급
    def get_access_token():
        headers = {"content-type": "application/json"}
        body = {
            "grant_type": "client_credentials",
            "appkey": KIS_APP_KEY,
            "appsecret": KIS_APP_SECRET
        }
        PATH = "oauth2/tokenP"
        URL = f"{KIS_URL_BASE}/{PATH}"
    
        res = requests.post(URL, headers=headers, data=json.dumps(body))
        access_token = res.json().get("access_token")
        return access_token
    
    KIS_ACCESS_TOKEN = get_access_token()
    ```
    
    ```python
    CANO = os.getenv("CANO")
    ACNT_PRDT_CD = os.getenv("ACNT_PRDT_CD")
    ```
    

이 부분은 이전 강의 (2,3,4)에서 이미 다루었던 내용입니다. 다만, 이번 강의에서는 두 가지 환경 변수만 추가하고 넘어갈게요! 

`CANO` (어카운트 넘버)에는 모의투자를 진행 중인 계좌번호 앞 8자리를 입력해주시면 됩니다. 
그리고 `ACNT_PRDT_CD` (어카운트 프로덕트 코드) 에는 계좌번호 뒤 2자리를 채워주시면 됩니다. 

이 두 정보는 주문을 넣을 때 필수적으로 필요한 정보입니다.

## 주식 주문을 위한 핵심 함수

자, 이제 주식 주문을 위한 함수를 제작해보겠습니다.
주문을 넣기 위해선 크게 두 가지 핵심 기능이 필요합니다.

첫 번째로는 주문을 넣으려는 주식 종목의 현재가를 가져오는 기능이고,
두 번째로는 실제로 주문을 넣는 기능입니다.

이 두 기능을 각각의 함수로 구현해 보겠습니다.

### 1. 현재가 조회 함수

먼저, 주문을 넣으려는 주식 종목의 현재가를 가져오는 함수부터 만들어 보겠습니다.

- api 문서_해외주식 **현재체결가**
    
    ![image.png](attachment:c38bccf9-1145-4555-9381-ab5bf8692249:image.png)
    
    ![image.png](attachment:d00fc8da-fdc0-4693-b69f-3e355002e2fb:image.png)
    
    ![image.png](attachment:7a3931fa-7d8c-43ff-8951-3c2d4415a826:image.png)
    
- 코드 (해외 주식의 현재가를 조회하는 함수)
    
    ```python
    def get_current_price(market_code: str,
                          product_code: str) -> dict:
        """해외 주식의 현재가를 조회하는 함수"""
        path = "/uapi/overseas-price/v1/quotations/price"
        url = f"{KIS_URL_BASE}/{path}"
    
        headers = {
            "content-type": "application/json; charset=utf-8",
            "authorization": f"Bearer {KIS_ACCESS_TOKEN}",
            "appkey": KIS_APP_KEY,
            "appsecret": KIS_APP_SECRET,
            "tr_id": "HHDFS00000300",
            "custtype": "P"
        }
    
        params = {
            "AUTH": "",
            "EXCD": market_code,  # 거래소 코드 (NAS: 나스닥)
            "SYMB": product_code  # 종목 코드 (AAPL: 애플)
        }
    
        time.sleep(0.1)  # API 호출 제한 방지
        response = requests.get(url, headers=headers,
                                params=params)
        data = response.json()
    
        return data
    
    # 애플(AAPL) 현재 시세 조회
    result = get_current_price("NAS", "AAPL")
    current_price = float(result['output']['last'])
    print(f"애플(AAPL) 현재가: ${current_price}")
    ```
    

함수를 만들기 위해 이전에 했던 것처럼 API 문서부터 확인해 볼까요?

요청 헤더부터 확인하면, 이전에 저희가 작성했던 인증 정보와 함께 거래 ID인 tr_id (티알 아이디)가 필요합니다. 이 값은 문서에 적힌 대로 넣어줄게요.

그 다음, Query parameter를 살펴보면
첫 번째 항목은 사용자권한정보로 문서에 적힌대로 비워두시면 됩니다.
두 번째 항목은 거래소 코드로, 거래하고 싶은 해외 시장의 코드를 확인하여 채우면 됩니다. 저희는 나스닥 거래소에서 거래를 진행할 예정이니 `NAS`(엔 에이 에스)를 채워주도록 할게요.
세 번째 항목은 종목 코드로 조회하고 싶은 기업 코드를 넣으면 됩니다. 저희는 애플의 코드인 `AAPL`(에이 에이 피 엘)을 채워넣어 줄게요.

이제 값을 채워넣었으니, 한번 함수를 실행시켜 볼까요?

![image.png](attachment:6c782760-99d0-472b-9d7c-23ea7c4aaab0:image.png)

```python
애플(AAPL) 현재가: $192.6955
```

어떤가요? 애플의 현재 가격이 잘 출력되는 모습을 확인할 수 있습니다.

### 2. 주문 실행 함수

현재가를 조회하는 함수를 만들었으니, 이제는 이렇게 해서 얻은 현재가를 통해 매수/매도를 진행하는 함수를 만들어 보겠습니다.

- api 문서_해외주식 주문
    
    ![image.png](attachment:90b97187-c56e-4585-963d-cb9ade978792:image.png)
    
    ![image.png](attachment:486cbe22-e99e-4945-b30b-8c2e3bfa3263:image.png)
    
    ![image.png](attachment:c3bf27cc-7338-442b-bc5f-97733d496ac6:image.png)
    
- 코드 (해외 주식을 주문하는 함수)
    
    ```python
    def order_ovs_stock(market_code: str, product_code: str,
        quantity: str, price: str, is_buy: bool = True,
    ) -> dict:
        """해외 주식을 주문하는 함수"""
        path = "/uapi/overseas-stock/v1/trading/order"
        url = f"{KIS_URL_BASE}/{path}"
        # 매수/매도에 따른 거래 ID 선택 (모의투자 미국 기준)
        tr_id = "VTTT1002U" if is_buy else "VTTT1001U"
    
        headers = {
            "content-type": "application/json",
            "authorization": f"Bearer {KIS_ACCESS_TOKEN}",
            "appkey": KIS_APP_KEY,
            "appsecret": KIS_APP_SECRET,
            "tr_id": tr_id,
            "custtype": "P"
        }
    
        payload = {
            "CANO": CANO,  # 계좌번호 앞 8자리
            "ACNT_PRDT_CD": ACNT_PRDT_CD,  # 계좌상품코드 (뒤 2자리)
            "OVRS_EXCG_CD": market_code,  # 거래소 코드
            "PDNO": product_code,  # 종목 코드
            "ORD_QTY": quantity,  # 주문 수량
            "OVRS_ORD_UNPR": price,  # 주당 가격 
            "SLL_TYPE": "" if is_buy else "00",
            "ORD_SVR_DVSN_CD": "0",
            "ORD_DVSN": "00"  # 미국 모의투자는 00: 지정가만 가능
        }
    
        time.sleep(0.1)
        response = requests.post(url, headers=headers,
                                 json=payload)
        data = response.json()
    
        return data
        
    # 매수 주문 실행
    order_result = order_ovs_stock(
        market_code="NAS",  # 나스닥
        product_code="AAPL",  # 애플
        quantity="10",  # 10주
        price="190",  # 지정가 주문
        is_buy=True  # 매수
    )
    print(f"주문 결과: {order_result}")
    ```
    

자, 이번에도 API 문서를 확인해볼까요?

API 문서를 확인해보니 매수/매도 둘 다 비슷한 파라미터를 사용하니 같이 작성해 보겠습니다!

해외 주식을 주문하기 위해 사용되는 `tr_id` (티알 아이디)는 여러개가 있지만 저희는 미국장을 이용할 예정이기 때문에 모의투자의 “미국 매수 주문”, “미국 매도 주문”이라 적혀있는 값을 가져다 사용할게요.

그 다음으로 쿼리 파라미터를 보겠습니다.

계좌 번호를 나타내는 항목들은 이전과 동일하게 해주면 됩니다.

다음은 해외 거래소 코드(`OVRS_EXCG_CD`)인데요, 예를 들어 나스닥 종목을 거래하고 싶으면 그에 해당하는 코드인 "NAS"를 채워주면 됩니다.

다음 항목(`PDNO`)은 종목 코드입니다. “AAPL” 같은 코드를 전달하면 됩니다.

주문 수량(`ORD_QTY`)은 몇 주를 매수할지 결정하는 값으로, 여기서는 10주를 예시로 사용해 보겠습니다.

주문 가격(`OVRS_ORD_UNPR`)은 지정가 주문 시 사용되는 가격입니다.

다음 항목은 매수/매도 여부를 구분하는 항목입니다. 

주문 서버 코드는 기본값인 0을 채우고,

지정가-시장가 구분 같은 경우 모의투자에서는 지정가 주문만 가능하다고 나와있어 그에 맞게 값을 채워주겠습니다.

이렇게 여러 파라미터 중에서 거래소 코드, 종목 코드, 주문 수량, 주문 가격, 매수/매도 구분 등은 거래할 때마다 자주 바뀌는 값들이니, 함수의 파라미터로 받아서 유연하게 사용할 수 있도록 함수로 만들어둘게요.

한번 실행해볼까요?

프린트 된 결과를 확인해보니, “모의투자 매수 주문이 완료 되었습니다”라고 출력되네요.

```jsx
주문 결과: {'rt_cd': '0', 'msg_cd': '40600000', 'msg1': '모의투자 매수주문이 완료 되었습니다.', 'output': {'KRX_FWDG_ORD_ORGNO': '00950', 'ODNO': '0000010358', 'ORD_TMD': '025323'}}
```

## 한투 앱에서 주문 확인하기

코드 상에서는 매수 주문이 완료되었다고 떴으니, 실제로도 잘 되었는지 한투 앱에서 확인해볼까요?
이렇게 앱에서 직접 확인하는 것은 코드가 정상적으로 작동하는지 검증하는 좋은 방법입니다.

- 사진 (매수 진행, 체결 x)
    
    ![image.png](attachment:3caa91bf-16b3-453c-970e-e86f635ff20e:image.png)
    

저희가 방금 실행한 코드를 통해 10주 매수 주문에 성공했고, 체결 대기 중인 것을 확인할 수 있습니다.

만약 주식 가격이 우리가 주문을 넣어 둔 가격만큼 떨어지면 체결이 되겠죠?
일단 지금은 체결이 잘 되는 것까지 확인을 해보기 위해 이 주문은 취소하고, 현재 가격 그대로 주문을 넣어보겠습니다

## 체결되는 매수 주문 실행하기

이제 저희가 만든 함수들을 조합하여 바로 체결이 되도록 하는 매수 주문 코드를 작성해볼까요?

- 코드 (매수 주문 실행)
    
    ```python
    # 애플(AAPL) 현재 시세 조회
    result = get_current_price("NAS", "AAPL")
    current_price = float(result['output']['last'])
    print(f"애플(AAPL) 현재가: ${current_price}")
    
    # 매수 주문 실행
    order_result = order_ovs_stock(
        market_code="NAS",  # 나스닥
        product_code="AAPL",  # 애플
        quantity="10",  # 10주
        price=str(current_price),  # 지정가 주문
        is_buy=True  # 매수
    )
    print(f"주문 결과: {order_result}")
    ```
    

먼저, 채결되는 매수를 진행하기 위해선 현재 시세에 맞춰 주문을 넣어야 하니,
처음에 작성한 함수를 호출하여 현재 시세를 가져오겠습니다. 
그리고 주문 실행 함수를 호출해서 나스닥 거래소의 애플 주식을 현재 시세로 10주 매수를 진행해볼게요.

이번에도 “모의투자 매수 주문이 완료 되었습니다”라고 출력되네요

```python
주문 결과: {'rt_cd': '0', 'msg_cd': '40600000', 'msg1': '모의투자 매수주문이 완료 되었습니다.', 'output': {'KRX_FWDG_ORD_ORGNO': '00950', 'ODNO': '0000010358', 'ORD_TMD': '025323'}}
```

한번 한투앱에서 다시 확인해볼까요?

- 사진 (매수 진행, 체결 o)
    
    
    ![체결되기 직전 순간](attachment:903d6a07-8260-4df1-a85d-a3f6ca5a3ba8:IMG_1772.png)
    
    체결되기 직전 순간
    
    ![체결되는 순간](attachment:1a6735a7-7248-489e-8fc2-f160d1b96992:IMG_1773.png)
    
    체결되는 순간
    
    ![체결이 되어서 잔고에 들어와 있는 장면](attachment:5a4cda8a-44e7-4b3d-911d-3f02a215fdb8:IMG_1774.png)
    
    체결이 되어서 잔고에 들어와 있는 장면
    

현재가로 매수를 진행했기 때문에 체결이 잘 되었고 잔고에도 잘 들어간 모습이 확인이 되네요!

## 매도 주문 넣기

이제 매도 주문도 진행해 보겠습니다. 
주문을 실행하는 함수를 만들 때, 매도 코드까지 같이 작성했기 때문에 코드가 크게 다르진 않습니다!
단순히 `is_buy` 매개변수를 False로 설정한다는 차이가 있습니다!

- 코드 (매도 주문 넣기)
    
    ```python
    # 애플(AAPL) 현재 시세 조회
    result = get_current_price("NAS", "AAPL")
    current_price = float(result['output']['last'])
    print(f"애플(AAPL) 현재가: ${current_price}")
    
    # 매도 주문 실행
    order_result = order_ovs_stock(
        market_code="NAS",  # 나스닥
        product_code="AAPL",  # 애플
        quantity="10",  # 10주
        price=str(current_price),  # 지정가 주문
        is_buy=False  # 매도
    )
    print(f"주문 결과: {order_result}")
    ```
    
- 사진 (매도 성공)
    
    
    ![매도 체결 직전](attachment:17bdf717-149d-415a-9dd8-3ff2793a30a0:image.png)
    
    매도 체결 직전
    
    ![매도 체결 되는 순간](attachment:35b2e85a-7b4a-44ae-9697-71f7a85b8b67:image.png)
    
    매도 체결 되는 순간
    
    ![매도 완료 돼서 잔고가 비어 있는 장면](attachment:8d0fe074-c935-4698-907a-39d11d045476:IMG_1780.png)
    
    매도 완료 돼서 잔고가 비어 있는 장면
    

코드를 돌려보면 매수와 마찬가지로 현재가로 매도를 진행하여 매도가 체결된 모습을 확인할 수 있습니다.

## 매도 주문 시 발생할 수 있는 예외 상황

코드를 작성하다 보면 예상하지 못한 예외 상황이 발생할수도 있어요!
함께 살펴볼까요?

현재 저희는 애플 주식을 10주 보유한 상황입니다.

여기서, 보유하고 있는 주식보다 더 많은 양을 매도하려고 하면 어떻게 될까요?

한 번, 보유 수량보다 더 많은 100주로 매도 시도를 해볼게요!

### 1. 보유 수량보다 많은 양을 매도하려는 경우

```python
# 보유 수량보다 많은 100주 매도 시도
order_result = order_ovs_stock(
    market_code="NAS",
    product_code="AAPL",
    quantity="100",  # 보유 수량보다 많은 100주
    price=str(current_price),
    is_buy=False  # 매도
)
print(f"주문 결과: {order_result}")

```

실행 결과:

```
주문 결과: {'rt_cd': '1', 'msg_cd': '40240000', 'msg1': '모의투자 잔고내역이 없습니다.'}
```

실행 결과를 보니, “모의투자 잔고내역이 없습니다”라고 출력되네요!

### 2. 보유하지 않은 종목을 매도하려는 경우

그렇다면 보유하지 않은 종목을 매도 시도하면 어떻게 될까요?
저희가 방금 구매한 애플 주식이 아닌 테슬라로 시도해보겠습니다!
테슬라의 product_code는 TSLA니까 그렇게 적어주고, 코드를 실행해볼게요.

```python
# 보유하지 않은 테슬라 매도 시도
result = get_current_price("NAS", "TSLA")
current_price = float(result['output']['last'])

order_result = order_ovs_stock(
    market_code="NAS",
    product_code="TSLA",  # 보유하지 않은 테슬라
    quantity="5",
    price=str(current_price),
    is_buy=False  # 매도
)
print(f"주문 결과: {order_result}")

```

실행 결과:

```
주문 결과: {'rt_cd': '1', 'msg_cd': '40240000', 'msg1': '모의투자 잔고내역이 없습니다.'}
```

보유 수량보다 더 많이 넣은 것과 마찬가지로 보유하지 않은 종목을 매도하려고 할 때도 같은 오류가 발생하는 것을 확인할 수 있네요!
그렇기 때문에 보유 종목과 수량을 잘 기억하여 매개변수에 잘 넣어줘야 할 필요성이 있습니다!
아니면, API 문서를 참고하여 보유 수량을 가져오는 함수도 만들어보는 것도 좋겠죠?

- API_매도가능수량조회
    
    https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock-order#L_b71fba6a-5759-4efa-a7e0-5e93e7e0e02d
    
    ![image.png](attachment:140d9630-bc87-47ae-877b-4551b5054620:image.png)
    

## 정리

지금까지 주식 주문을 프로그래밍으로 실행하는 방법에 대해 알아보았습니다. ~~이제 여러분은 현재가를 조회하여 매수 및 매도 주문을 넣는 법에 대해 배웠습니다.~~ 이번 강의에서는 현재가를 기준으로 매수 시도를 했지만, 이전 강의에서 배운 AI 분석을 이용한다면 자동화 투자까지 프로젝트를 확장할 수 있을 겁니다.

다음 강의에서는 특정 기간마다 정해진 금액을 매수하는 방법에 대해 알아보겠습니다. 

그럼 다음 시간에 만나요!

---

### **1️⃣ 주식 주문을 위한 기본 설정**

- 주식 주문을 실행하기 위해서는 증권사 API 인증 정보와 계좌 정보가 필요합니다.
    - 해당 정보는 보안과 안정성을 위해 환경 변수로 관리합니다.

```python
import pandas as pd
import requests
import json
import time
import os
from dotenv import load_dotenv

# 환경 변수 로드
load_dotenv()

# 환경 변수에서 API 인증 정보 불러오기
KIS_URL_BASE = os.getenv("KIS_URL_BASE")
KIS_APP_KEY = os.getenv("KIS_APP_KEY")
KIS_APP_SECRET = os.getenv("KIS_APP_SECRET")
# 환경 변수에서 계좌 정보 불러오기
CANO = os.getenv("CANO")  # 계좌번호 앞 8자리
ACNT_PRDT_CD = os.getenv("ACNT_PRDT_CD")  # 계좌상품코드 (뒤 2자리)
```

- 접근 토큰 발급 기능을 함수로 정의합니다.

```python
# 접근 토큰 발급 함수
def get_access_token():
    headers = {"content-type": "application/json"}
    body = {
        "grant_type": "client_credentials",
        "appkey": KIS_APP_KEY,
        "appsecret": KIS_APP_SECRET
    }
    PATH = "oauth2/tokenP"
    URL = f"{KIS_URL_BASE}/{PATH}"

    res = requests.post(URL, headers=headers, data=json.dumps(body))
    access_token = res.json().get("access_token")
    return access_token

KIS_ACCESS_TOKEN = get_access_token()
```

<aside>
⚠️

**여기서 잠깐!**

- 계좌 정보는 매우 민감한 개인정보이므로 환경 변수 파일(.env)에 저장하고 이를 코드에서 불러오는 방식을 사용합니다.
- 모의투자 계좌와 실제 계좌를 혼동하지 않도록 주의해야 합니다.
</aside>

### **2️⃣ 현**재가 조회 함수 구현하기

- 주문을 넣기 전에 종목의 현재가를 조회하는 함수는 필수적입니다.
- API 문서에 명시된 파라미터에 맞게 함수를 구현합니다.

![image.png](attachment:a5d43d79-2d5d-48f4-8724-ccefdca4420e:image.png)

![image.png](attachment:88e45f09-dc9e-440c-ae69-ba70f3d5ce95:image.png)

```python
# 해외주식 현재체결가 조회 함수
def get_current_price(market_code: str, product_code: str) -> dict:
    path = "/uapi/overseas-price/v1/quotations/price"
    url = f"{KIS_URL_BASE}/{path}"

    headers = {
        "content-type": "application/json; charset=utf-8",
        "authorization": f"Bearer {KIS_ACCESS_TOKEN}",
        "appkey": KIS_APP_KEY,
        "appsecret": KIS_APP_SECRET,
        "tr_id": "HHDFS00000300",
        "custtype": "P"
    }

    params = {
        "AUTH": "",
        "EXCD": market_code,  # 거래소 코드 (NAS: 나스닥)
        "SYMB": product_code  # 종목 코드 (AAPL: 애플)
    }

    time.sleep(0.1)  # API 호출 제한 방지
    response = requests.get(url, headers=headers, params=params)
    data = response.json()

    return data
```

- 종목 코드를 애플(”AAPL”)로 설정하고, 실행 결과를 확인합니다.

```python
# 애플(AAPL) 현재 시세 조회
result = get_current_price("NAS", "AAPL")
current_price = float(result['output']['last'])
print(f"애플(AAPL) 현재가: ${current_price}")
```

```
애플(AAPL) 현재가: $192.6955
```

### **3️⃣ 주문 실행 함수 구현하기**

- 해외주식 주문 API 문서를 확인합니다

![image.png](attachment:143676e7-baba-490e-abe3-81968d998e55:image.png)

![image.png](attachment:c3bf27cc-7338-442b-bc5f-97733d496ac6:image.png)

![image.png](attachment:dd837da5-4abb-457f-9360-cc8b22fe71a9:65163c04-745e-425a-9c3f-6bf66f6358da.png)

- 주식 주문을 실행하는 함수는 매수와 매도 기능을 모두 처리하도록 설계합니다.
    - 매개변수로 거래소 코드, 종목 코드, 수량, 가격, 매수/매도 여부를 받습니다.
    - 파라미터로 계좌번호 정보, 거래소 코드(OVRS_EXCG_CD), 종목 코드(PDNO), 주문 수량(ORD_QTY), 주문 가격(OVRS_ORD_UNPR), 매수/매도 여부 구분(SLL_TYPE)을 입력합니다.

```python
def order_ovs_stock(market_code: str, product_code: str,
    quantity: str, price: str, is_buy: bool = True,
) -> dict:
    """해외 주식을 주문하는 함수"""
    path = "/uapi/overseas-stock/v1/trading/order"
    url = f"{KIS_URL_BASE}/{path}"
    tr_id = "VTTT1002U" if is_buy else "VTTT1001U" # 매수/매도에 따른 거래 ID 선택 (모의투자 미국 기준)

    headers = {
        "content-type": "application/json",
        "authorization": f"Bearer {KIS_ACCESS_TOKEN}",
        "appkey": KIS_APP_KEY,
        "appsecret": KIS_APP_SECRET,
        "tr_id": tr_id,
        "custtype": "P"
    }

    payload = {
        "CANO": CANO,  # 계좌번호 앞 8자리
        "ACNT_PRDT_CD": ACNT_PRDT_CD,  # 계좌상품코드 (뒤 2자리)
        "OVRS_EXCG_CD": market_code,  # 거래소 코드
        "PDNO": product_code,  # 종목 코드
        "ORD_QTY": quantity,  # 주문 수량
        "OVRS_ORD_UNPR": price,  # 주당 가격 
        "SLL_TYPE": "" if is_buy else "00",
        "ORD_SVR_DVSN_CD": "0",
        "ORD_DVSN": "00"  # 미국 모의투자는 00: 지정가만 가능
    }

    time.sleep(0.1)
    response = requests.post(url, headers=headers,
                             json=payload)
    data = response.json()

    return data
```

- 조회한 현재가로 매수 주문을 실행하고, 앱에서 결과를 확인합니다.

```python
# 매수 주문 실행
order_result = order_ovs_stock(
    market_code="NAS",  # 나스닥
    product_code="AAPL",  # 애플
    quantity="10",  # 10주
    price="190",  # 지정가 주문
    is_buy=True  # 매수
)
print(json.dumps(order_result, ensure_ascii=False, indent=4))
```

```json
{   
    'msg1': '모의투자 매수주문이 완료 되었습니다.', 
    'msg_cd': '40600000', 
    'output': {
        'KRX_FWDG_ORD_ORGNO': '00950', 
        'ODNO': '0000013941', // 주문번호
        'ORD_TMD': '025323' // 주문시각
    },
    'rt_cd': '0'
}
```

![image.png](attachment:3caa91bf-16b3-453c-970e-e86f635ff20e:image.png)

<aside>
⚠️

**여기서 잠깐!**

- KIS API에서 미국 모의투자는 지정가 주문만 가능합니다(ORD_DVSN: "00").
    - 실전에서는 시장가 주문 등 다양한 주문 유형을 지원합니다.
</aside>

### **4️⃣ 매수, 매도 주문 체결하기**

- 현재 시세 조회, 주문 실행 함수를 조합하여 매수 주문을 체결합니다.

```python
# 애플(AAPL) 현재 시세 조회
result = get_current_price("NAS", "AAPL")
current_price = float(result['output']['last'])
print(f"애플(AAPL) 현재가: ${current_price}")

# 매수 주문 실행
order_result = order_ovs_stock(
    market_code="NAS",  # 나스닥
    product_code="AAPL",  # 애플
    quantity="10",  # 10주
    price=str(current_price),  # 지정가 주문
    is_buy=True  # 매수
)
print(json.dumps(order_result, ensure_ascii=False, indent=4))
```

```json
{   
    'msg1': '모의투자 매수주문이 완료 되었습니다.', 
    'msg_cd': '40600000', 
    'output': {
        'KRX_FWDG_ORD_ORGNO': '00950', 
        'ODNO': '0000013960',
        'ORD_TMD': '232547'
    },
    'rt_cd': '0'
}
```

![체결되는 순간](attachment:1a6735a7-7248-489e-8fc2-f160d1b96992:IMG_1773.png)

체결되는 순간

![체결이 되어서 잔고에 들어와 있는 장면](attachment:5a4cda8a-44e7-4b3d-911d-3f02a215fdb8:IMG_1774.png)

체결이 되어서 잔고에 들어와 있는 장면

- 현재 시세를 조회한 후 그 가격으로 매도 주문을 체결합니다.
    - 작성한 매매 함수에서 is_buy 매개변수를 False로 설정합니다.

```python
# 애플(AAPL) 현재 시세 조회
result = get_current_price("NAS", "AAPL")
current_price = float(result['output']['last'])
print(f"애플(AAPL) 현재가: ${current_price}")

# 매도 주문 실행
order_result = order_ovs_stock(
    market_code="NAS",  # 나스닥
    product_code="AAPL",  # 애플
    quantity="10",  # 10주
    price=str(current_price),  # 지정가 주문
    is_buy=False  # 매도
)
print(json.dumps(order_result, ensure_ascii=False, indent=4))
```

![매도 체결 되는 순간](attachment:35b2e85a-7b4a-44ae-9697-71f7a85b8b67:image.png)

매도 체결 되는 순간

![매도 완료 돼서 잔고가 비어 있는 장면](attachment:8d0fe074-c935-4698-907a-39d11d045476:IMG_1780.png)

매도 완료 돼서 잔고가 비어 있는 장면

### **5️⃣ 예외 상황 처리하기**

- 주문 실행 시 다양한 예외 상황이 발생할 수 있습니다.
- 매도 주문은 보유한 주식에 대해서만 가능합니다.
    - 보유량보다 많은 주식을 매도하려고 하면 오류가 발생합니다.

```python
# 보유 수량보다 많은 100주 매도 시도
order_result = order_ovs_stock(
    market_code="NAS",
    product_code="AAPL",
    quantity="100",  # 보유 수량보다 많은 100주
    price=str(current_price),
    is_buy=False  # 매도
)
print(json.dumps(order_result, ensure_ascii=False, indent=4))
```

```json
{
    "msg1": "모의투자 잔고내역이 없습니다.",
    "msg_cd": "40240000",
    "rt_cd": "1"
}
```

- 보유하지 않은 종목을 매도하려는 경우에도 오류가 발생합니다.
    - 종목코드를 보유하지 않은 “TSLA”로 변경하는 경우에도 같은 오류가 발생합니다.

```python
# 보유하지 않은 테슬라 매도 시도
result = get_current_price("NAS", "TSLA")
current_price = float(result['output']['last'])

order_result = order_ovs_stock(
    market_code="NAS",
    product_code="TSLA",  # 보유하지 않은 종목코드
    quantity="5",
    price=str(current_price),
    is_buy=False  # 매도
)
print(json.dumps(order_result, ensure_ascii=False, indent=4))
```

- 주문 실행 전에 오류를 방지하기 위한 검증 로직을 추가하는 것이 좋습니다.
    - 국내/해외 보유 종목 조회 API를 활용하여 매도 가능 수량을 미리 확인할 수 있습니다.

![image.png](attachment:7477d708-3430-4e71-8f5e-2cba2aec6e96:image.png)

![image.png](attachment:42bf02a0-5cb0-4fbe-82e1-e9a60b3951d1:image.png)

<aside>
➕

**API 응답의 오류 처리**

- API 응답에서 오류 코드와 메시지를 항상 확인해야 합니다.
- 오류 메시지가 발생했을 때 적절히 대응하는 예외 처리 로직이 필요합니다.
    - 주식 자동매매 시스템의 경우 주문 결과를 단순히 출력하기보다 로그로 저장하거나 알림을 보내는 것이 안정적인 운영에 도움이 됩니다.
</aside>