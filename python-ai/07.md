# 차트 분석 시키기

안녕하세요, 여러분! 반갑습니다.

지난 시간까지 우리는 주식 데이터를 가져와서 멋진 차트로 그려보는 방법을 배웠습니다. 이제 좀 더 흥미로운 일을 해볼 차례인데요, 바로 인공지능에게 이 차트를 분석하도록 시키는 겁니다!

## 기술적 분석이란?

먼저 '기술적 분석'이 무엇인지 간단히 알아볼게요.

기술적 분석은 주가의 과거 움직임을 토대로 미래 가격 움직임을 예측하는 방법입니다. 차트 패턴, 이동평균선 같은 지표들을 활용해 매수/매도 시점을 판단하는 데 도움을 주죠.

전통적으로 이런 분석은 전문가들이 직접 차트를 보면서 했지만, 이제 우리는 AI의 도움을 받아 이 과정을 자동화할 수 있답니다.

## 기본 설정하기

먼저 필요한 라이브러리와 환경을 설정해 볼게요.

```python
# library import
import pandas as pd
import json
import os
from pathlib import Path

from dotenv import load_dotenv
from openai import OpenAI
```

차트 데이터와 응답 처리를 위해 pandas, json 라이브러리가 필요합니다. 또 기본 경로, 환경 변수 설정을 위해 os, Path, dotenv 라이브러리를 사용합니다. 마지막으로 OpenAI 라이브러리를 가져와 API를 통해 모델 응답을 얻을 수 있게 합니다.

이제 환경변수, 분석할 종목과 파일 경로를 설정해 볼게요.

```python
# .env 파일 로드
load_dotenv()

# 환경 변수에서 필요한 값들 가져오기
KIS_URL_BASE = os.getenv("KIS_URL_BASE")
KIS_APP_KEY = os.getenv("KIS_APP_KEY")
KIS_APP_SECRET = os.getenv("KIS_APP_SECRET")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

openai_client = OpenAI(api_key = OPENAI_API_KEY)
```

```python
# 시장 구분(국내/해외), 종목 코드
market = "ovs"
currency = "KRW" if market == "dom" else "USD"
stock_code = "AAPL"

# 파일 경로 지정
root_path = Path(__vsc_ipynb_file__).parent
# 읽어올 차트 경로
chart_data_path = root_path / "data"
# 보고서 저장 경로
report_path = root_path / "report"

# 경로 생성
chart_data_path.mkdir(parents = True,
                      exist_ok = True)
report_path.mkdir(parents = True,
                  exist_ok = True)
```

## 간단한 기술적 분석 보고서 작성하기

자, 이제 본격적으로 AI에게 차트 분석을 시켜볼까요?
먼저 지난 시간에 만든 차트 데이터와 이동평균선 데이터를 불러와 보겠습니다.

```python
# 차트 데이터 로드
# {stock_code}_ma.csv: 최근 6개월 차트 + 이동평균 계산한 파일
df = pd.read_csv(chart_data_path / f"{stock_code}_ma.csv")

```

![스크린샷 2025-04-01 오전 10.00.09.png](attachment:45159c40-9343-4b7e-b884-1b45e25404bb:스크린샷_2025-04-01_오전_10.00.09.png)

그리고 OpenAI API로 전달할 수 있게 json 형식으로 변환합니다.

```python
# JSON 형식으로 변환: 프롬프트에 포함
df_json = df.to_json(orient = "records",
                     indent = 4, force_ascii = False)
```

데이터를 살펴봤으니, AI에게 분석을 요청할 프롬프트를 작성해볼게요.

```python
# 프롬프트 작성
prompt_tech_dev = f"""
너는 전문 투자 분석가야.
다음 기업의 최근 6개월 간 일봉 데이터와 기술적 지표들을 참고하여 이 기업에 대한 Markdown 형식의 기술적 분석 결과를 한국어로 출력해.
매수/매도 전략을 직접적으로 추천하지는 말고, 투자에 참고할 만한 차트 분석 결과를 제시해줘.
"""
prompt_tech_user = f"최근 주가 시세 및 이동평균 ({currency}): " + df_json
```

여기서 프롬프트를 두 부분으로 나눴습니다:

1. `prompt_tech_dev`: 시스템, 혹은 개발자 프롬프트는 AI의 역할과 작업 내용, 결과물 형식을 정의합니다.
2. `prompt_tech_user`: 사용자 프롬프트에는 실제 분석할 데이터를 포함합니다. 데이터의 내용과 통화 단위를 함께 입력해줬습니다.

이렇게 나누면 각 부분의 역할이 명확해지고, 나중에 수정하기도 쉬워집니다.

이제 OpenAI API를 호출해볼게요:

```python
# API 호출
response = openai_client.chat.completions.create(
    model="o3-mini",
    messages=[
        {"role": "developer", "content": prompt_tech_dev},
        {"role": "user", "content": prompt_tech_user}
    ],
    reasoning_effort="low"
)
```

여기서 지정한 옵션을 살펴봅시다:

- (`model="o3-mini"`): 먼저 추론 모델(reasoning model)의 일종을 사용했는데요. 추론 모델은 응답을 내놓기 전에 내부적으로 추론 과정을 거쳐 더 정확하고 믿을 수 있는 결과를 출력합니다. 따라서 주식 분석처럼 수치 데이터를 다루거나 복잡한 논리적 추론이 필요한 작업에 적합합니다.
- (`reasoning_effort="low"`): 또 일부 추론 모델은 사용 목적에 따라 추론 강도를 설정할 수 있습니다. 간단한 분석에는 "low"로 충분하고, 더 자세한 분석이 필요하면 "medium"이나 "high"로 설정할 수 있습니다.

받은 응답을 파일로 저장해볼게요:

```python
# 보고서 저장
with open(report_path / f"{stock_code}_v1.md",
          "w") as f:
    f.write(response.choices[0].message.content)
```

생성한 보고서는 이런 내용을 담고 있습니다:

```markdown
아래는 최근 6개월 일봉 데이터와 주요 이동평균선(MA5, MA20, MA60, MA120)을 기반으로 한 기술적 분석 결과입니다. 이 분석은 투자 판단의 참고자료로 활용하시기 바라며, 특정 매매 전략을 직접적으로 추천하지 않습니다.

---

### 1. 가격 추세 및 변동성

• 전반적으로 주가는 중기(60일, 120일) 이동평균선 위와 아래를 오가며 횡보와 단기 조정 국면이 반복되고 있는 모습을 보입니다.  
• 최근 몇 주(2025년 1월 말 ~ 2월 초)에는 다소 하락세를 보이며 단기 MA5와 종가가 다소 낮은 수준에서 형성되었습니다.  
• 다만, 6개월 전보다 120일 이동평균선이 상승하는 등 장기 추세는 상승 모멘텀을 유지한 듯한 양상도 관찰됩니다.

---

### 2. 이동평균선 분석

• MA5와 MA20의 가격 차이는 단기 모멘텀을 보여주는데, 최근 MA5(약 245.8)와 MA20(약 238.4) 간 격차는 다소 벌어져 있어 단기 상승 모멘텀의 단기적 회복 가능성을 시사할 수 있습니다.  
• 중기(MA60)와 장기(MA120) 이동평균선은 꾸준히 상승세를 유지해온 모습을 보이나, 최근 종가가 이들보다 다소 낮은 수준에서 마감하는 경우가 많아 단기 조정 국면을 암시하는 모습도 있습니다.  
• 이동평균선 간의 교차(골든 크로스 혹은 데드 크로스)의 명확한 신호는 단기적으로 관측되지는 않으나, MA5와 MA20의 상대 위치 변화에 주의할 필요가 있습니다.

---

### 3. 거래량 및 변동성 지표

• 일부 거래일에서는 거래량이 급증하는 모습을 보였는데(예, 2024-09-20, 2024-12-20 등), 이는 중요한 가격 변동 시점에서 매수·매도 관심이 집중된 것으로 해석할 수 있습니다.  
• 최근 하락 장세와 함께 상대적으로 평균 거래량 대비 변동성이 소폭 확대된 모습이 관찰되어 단기 변동성 확대 가능성에 유의할 필요가 있습니다.

---

### 4. 최근 캔들 모양 및 단기 패턴

• 최신 데이터(2025-02-26 기준)에서는 시가 244.33, 종가 243.46로 소폭 하락 마감하였으며, 단기 이동평균선(MA5)이 245.8 수준에서 형성되어 단기 회복세와 조정 국면이 혼재한 상태로 보입니다.  
• 단기 캔들 패턴 측면에서는, 저가와 고가 간 폭이 상대적으로 좁아지는 모습을 통해 단기 매물량 조정 및 방향 전환 가능성에 주목할 필요가 있습니다.

---

### 5. 요약 및 투자 참고 포인트

• 장기적으로 MA120과 MA60이 상승하는 모습을 보면 상승 모멘텀은 유지되고 있으나, 단기적으로는 조정 국면과 횡보 구간이 관찰됩니다.  
• MA5와 MA20의 상대 위치 변화, 그리고 캔들 패턴 및 거래량 변동에 주의를 기울이며 추세 전환 신호(예: 단기 골든 크로스, 데드 크로스 등)를 모니터링하는 것이 도움이 될 수 있습니다.  
• 단기 변동성 확대 및 조정 국면으로 인해 투자 시 리스크 관리 및 여러 시간대의 차트 분석이 요구됩니다.

---

이상의 분석을 바탕으로 추가적 차트 분석 및 다양한 기술적 지표와의 조합을 고려하여 투자 판단하시기 바랍니다.
```

가격 추세, 이동평균선 분석, 거래량 분석, 캔들 패턴 등 다양한 측면에서 분석해주고 있네요. 훌륭합니다.

그래도 좀 더 개선할 수 있을 것 같은 지점이 보입니다.

지금은 투자에 참고할 정보를 제공하기 보다는, 사실들을 나열하기만 하는 경향이 있습니다.

또 판단의 근거가 되는 구체적인 날짜, 수치를 더 명확하게 짚어주면 좋겠네요.

## 더 상세한 분석 보고서 작성하기

앞에서 아쉬웠던 점들을 개선하기 위해, 프롬프트를 더 구체적으로 작성해보겠습니다.

```python
# 상세화한 프롬프트:
prompt_tech_dev_2 = f"""
너는 전문 투자 분석가야. 다음 기업의 최근 6개월 간 일봉 데이터와 기술적 지표들을 참고하여 이 기업에 대한 Markdown 형식의 기술적 분석 결과를 한국어로 출력해.
매수/매도 전략을 직접적으로 추천하지는 말고, 투자에 참고할 만한 차트 분석 결과를 제시해줘.
분석 결과는 투자 초보자도 이해할 수 있는 수준으로 쉽고 자세하게 설명하고, 차트에서 주목할만한 시점이 있다면 그 날짜와 정확한 수치를 근거로 들어줘.

보고서는 주어진 JSON 구조에 맞추고, 다음 섹션들을 포함해 작성해줘.
<report_headers>
종합 요약
이동평균선 분석
주요 차트 포인트
    - 지지 및 저항 영역, 거래량 변화, 추세 전환 시점 등
결론 및 투자 시사점
</report_headers>
"""
```

먼저 초보자도 이해할 수 있게 쉽게 설명하고, 날짜와 수치를 정확히 언급하도록 했습니다. 또 보고서에 포함해야 할 내용과 순서를 더 명시적으로 정해줬습니다.

이 프롬프트로 보고서를 생성해보겠습니다.

```python
# API 호출: 개발자 프롬프트 변경, response_format 추가
response = openai_client.chat.completions.create(
    model="o3-mini",
    messages=[
        {"role": "developer", "content": prompt_tech_dev_2},
        {"role": "user", "content": prompt_tech_user}
    ],
    reasoning_effort = "medium",
)
```

```markdown
아래 보고서는 최근 6개월간의 일봉 데이터와 이동평균선(MA) 지표를 토대로 작성되었습니다. 보고서는 주가의 주요 흐름, 단기 및 중기 이동평균선의 상호관계, 거래량의 급증 및 주요 지지/저항 영역 등을 투자자가 쉽게 이해할 수 있도록 설명하고 있습니다. 본 보고서는 투자 결정의 참고자료로 활용할 수 있으나, 직접적인 매수/매도 권고는 포함하지 않습니다.

---

## 종합 요약

분석기간 동안 주가는 2024년 8월 약 229달러에서 시작해 상승과 하락을 반복하며 2024년 12월 최고 259달러 근처까지 상승하였습니다. 이후 2025년 초에는 하락 조정을 보인 후 2월 말 다시 회복하는 양상을 보였습니다. 단기 변동성이 다소 큰 구간도 있었으나, 이동평균선의 흐름과 다수의 거래량 급증일을 통해 주요 전환점을 확인할 수 있습니다.

## 이동평균선 분석

단기(MA5)와 중기(MA20), 장기(MA60, MA120) 이동평균선들은 주가의 전반적인 추세 전환을 반영합니다. 초기에는 MA5가 MA20를 상회하며 상승세를 예고하였으나, 9월 초 단기선이 중기선 아래로 하락한 구간에서는 일시적인 약세 신호가 관찰되었습니다. 이후 11월 말 및 12월 초에는 MA5가 중기 및 장기선 위로 상승하며 강한 상승 전환(골든 크로스) 신호를 보였습니다. 다만, 2025년 초에는 MA5가 다시 하락세를 보이며 잠시 추세 전환의 경고를 주었으나, 2월 중순부터는 다시 단기선이 중기선을 상회하는 모습이 포착되어 회복세에 진입한 것으로 해석할 수 있습니다.

## 주요 차트 포인트

1. 지지 및 저항 영역: 2025년 1월 초에는 222 ~ 224달러 부근이 지속적인 지지선 역할을 한 것으로 보입니다. 반면, 2024년 12월에 형성된 254~259달러 부근은 단기 저항 영역으로 작용하였으며, 해당 영역에서 매물 매도 압력이 있었을 가능성이 있습니다.
2. 거래량 변화: 2024년 9월 20일(거래량 약 3.19억)과 2024년 12월 20일(거래량 약 1.47억)처럼 특정 일자의 거래량 폭증은 기관 투자자들의 참여 또는 주요 뉴스에 따른 변동성이 반영된 결과로 해석됩니다.
3. 추세 전환 시점: 11월 말 MA5와 MA20의 교차 및 12월 초 주가 상승은 강한 상승 전환 신호로 볼 수 있습니다. 2025년 1월 중순의 급락(예, 1월 16일 종가 228.26달러) 후 재회복하는 흐름은 단기 조정 후 엔트리 포인트로 참고될만한 전환 신호로 해석 가능합니다.

## 결론 및 투자 시사점

주가는 최근 몇 달간 상승과 조정 구간을 반복하면서 주요 이동평균선들의 교차와 거래량 급증을 통해 단기 및 중기 전환 신호를 제공하고 있습니다. 전반적으로 2월 말에는 단기 이동평균선이 중기선을 상회하는 등 회복세를 보이고 있으나, 변동성이 큰 시장 상황에서는 여러 기술적 지표를 종합적으로 참고하는 것이 중요합니다. 이번 분석은 투자 결정 시 참고자료로 활용할 수 있으며, 추가적인 펀더멘털 분석과 리스크 관리 전략을 병행하는 것이 바람직합니다.
```

생성한 결과를 살펴볼까요?

먼저 내용 측면에서는 구체적인 시기, 주가, 거래량이 더 자세히 제시되어 차트를 이해하는 데 도움이 됩니다.

전반적인 설명도 더 쉽게 풀어쓴 걸 확인할 수 있고요.

특히 차트에서 주목해서 봐야 할 부분을 짚어주니, 차트를 이해하는 데 도움이 많이 될 것 같습니다!

## 보고서 포맷팅

형식 측면에서도 포맷팅을 더 엄격하게 적용했습니다.

AI가 분석을 잘 해주긴 하지만, 기본적으로 확률에 기반해 작동하기 때문에 매번 다른 형식이 나올 수 있어요.

나중에 대시보드 제작까지 고려하면, 항상 통일된 형식으로 결과물이 나오도록 통제하는 게 필수적입니다.

지금은 짧은 인트로로 시작하고,

본문에는 종합 요약 - 이동평균선 분석 - 주요 차트 포인트 - 결론으로 이어지는 형식을 갖추도록 했습니다.

이렇게 이전보다 체계적이고 읽기 쉬운 형태로 만들 수 있죠.

생성 결과물 형식을 통제하는 방법은 다음과 같습니다.

먼저 우리가 원하는 결과물의 형식을 확정합니다.

그리고 AI 보고서 작성을 위해 API 호출을 할 때, 해당 형식에 맞춰서 결과를 반환하도록 요청합니다.

response_format 옵션에 원하는 JSON 스키마를 전달하면 됩니다.

이 스키마를 작성하는 게 좀 어렵게 보일 수 있는데요, 너무 걱정할 필요는 없습니다.

AI에게 목적과 필요한 항목 설명해주면, 원하는 구조를 쉽게 작성할 수 있습니다.

- before
  ![image.png](attachment:a9987cc4-e124-49d7-a980-0b4122350949:image.png)

![image.png](attachment:b516e919-380f-4d41-9a11-4acb5e2c4afe:image.png)

```python
# 응답 형식(json schema) 정의
tech_report_format = {"type": "json_schema", "json_schema": {
    "name": "technical_report",
    "schema": {
        "type": "object",
        "properties": {
            "intro": {
                "type": "string",
            },
            "technical_report": {"type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                        "heading": {"type": "string"},
                        "content": {"type": "string"}
                    },
                "required": ["heading", "content"],
                "additionalProperties": False
                },
            },
        },
        "required": ["intro", "technical_report"],
        "additionalProperties": False
        }
    }
}
```

```
{'intro': '아래 보고서는 최근 6개월간의 일봉 데이터와 이동평균선(MA) 지표를 토대로 작성되었습니다. 보고서는 주가의 주요 흐름, 단기 및 중기 이동평균선의 상호관계, 거래량의 급증 및 주요 지지/저항 영역 등을 투자자가 쉽게 이해할 수 있도록 설명하고 있습니다. 본 보고서는 투자 결정의 참고자료로 활용할 수 있으나, 직접적인 매수/매도 권고는 포함하지 않습니다.', 'technical_report': [{'heading': '종합 요약', 'content': '분석기간 동안 주가는 2024년 8월 약 229달러에서 시작해 상승과 하락을 반복하며 2024년 12월 최고 259달러 근처까지 상승하였습니다. 이후 2025년 초에는 하락 조정을 보인 후 2월 말 다시 회복하는 양상을 보였습니다. 단기 변동성이 다소 큰 구간도 있었으나, 이동평균선의 흐름과 다수의 거래량 급증일을 통해 주요 전환점을 확인할 수 있습니다.'}, {'heading': '이동평균선 분석', 'content': '단기(MA5)와 중기(MA20), 장기(MA60, MA120) 이동평균선들은 주가의 전반적인 추세 전환을 반영합니다. 초기에는 MA5가 MA20를 상회하며 상승세를 예고하였으나, 9월 초 단기선이 중기선 아래로 하락한 구간에서는 일시적인 약세 신호가 관찰되었습니다. 이후 11월 말 및 12월 초에는 MA5가 중기 및 장기선 위로 상승하며 강한 상승 전환(골든 크로스) 신호를 보였습니다. 다만, 2025년 초에는 MA5가 다시 하락세를 보이며 잠시 추세 전환의 경고를 주었으나, 2월 중순부터는 다시 단기선이 중기선을 상회하는 모습이 포착되어 회복세에 진입한 것으로 해석할 수 있습니다.'}, {'heading': '주요 차트 포인트', 'content': '1. 지지 및 저항 영역: 2025년 1월 초에는 222 ~ 224달러 부근이 지속적인 지지선 역할을 한 것으로 보입니다. 반면, 2024년 12월에 형성된 254~259달러 부근은 단기 저항 영역으로 작용하였으며, 해당 영역에서 매물 매도 압력이 있었을 가능성이 있습니다.\n2. 거래량 변화: 2024년 9월 20일(거래량 약 3.19억)과 2024년 12월 20일(거래량 약 1.47억)처럼 특정 일자의 거래량 폭증은 기관 투자자들의 참여 또는 주요 뉴스에 따른 변동성이 반영된 결과로 해석됩니다.\n3. 추세 전환 시점: 11월 말 MA5와 MA20의 교차 및 12월 초 주가 상승은 강한 상승 전환 신호로 볼 수 있습니다. 2025년 1월 중순의 급락(예, 1월 16일 종가 228.26달러) 후 재회복하는 흐름은 단기 조정 후 엔트리 포인트로 참고될만한 전환 신호로 해석 가능합니다.'}, {'heading': '결론 및 투자 시사점', 'content': '주가는 최근 몇 달간 상승과 조정 구간을 반복하면서 주요 이동평균선들의 교차와 거래량 급증을 통해 단기 및 중기 전환 신호를 제공하고 있습니다. 전반적으로 2월 말에는 단기 이동평균선이 중기선을 상회하는 등 회복세를 보이고 있으나, 변동성이 큰 시장 상황에서는 여러 기술적 지표를 종합적으로 참고하는 것이 중요합니다. 이번 분석은 투자 결정 시 참고자료로 활용할 수 있으며, 추가적인 펀더멘털 분석과 리스크 관리 전략을 병행하는 것이 바람직합니다.'}]}
```

그러면 다음과 같이 보고서 내용이 JSON 형태로 정리되어 오게 됩니다.

이제 이 내용들을 가독성 좋게 정리하면 됩니다.

이를 위해 마크다운 형식을 사용할 건데요,

마크다운 형식은 간단한 기호를 사용해 서식을 지정할 수 있어 읽고 쓰기 편하다는 장점이 있습니다.

구분선을 추가한다든가, 문단 사이에는 2줄의 공백을 둔다든가 하는 식으로요!

이렇게 해서 방금 보셨던 보고서가 탄생한 거랍니다!

```python
raw_response = json.loads(
    response.choices[0].message.content)
report_md = f"{raw_response['intro']}\\n\\n"
report_md += "---\\n\\n"
for item in raw_response['technical_report']:
    report_md += f"## {item['heading']}\\n\\n"
    report_md += f"{item['content']}\\n\\n"

with open(report_path / f"{stock_code}_v2.md",
          "w") as f:
    f.write(report_md)
```

## 마치며

이번 시간에는 AI를 활용해 주식 차트를 분석하는 방법을 배웠습니다. 이제 여러분은:

1. 차트 데이터를 AI에게 전달하는 방법과
2. 효과적인 분석 프롬프트 작성법을 알게 되었고요,
3. 구조화된 응답을 받는 ~~방법, 그리고~~
4. ~~그 응답 결과를 저장하고 활용하는~~ 방법까지,

알게 되었습니다!

그리고 오늘 보여드린 건 하나의 예시일 뿐이에요.

이걸 응용해서, 여러분 각자 중요하게 생각하는 지표와 관점을 추가한 분석 보고서를 만들어보세요!

그럼 다음 시간에 뵙겠습니다!

---

### 1️⃣ 기술적 분석과 AI

- 기술적 분석은 주가의 과거 움직임을 토대로 미래 가격을 예측하는 방법입니다.
- 차트 패턴, 이동평균선 등의 지표를 활용해 매수/매도 시점을 판단합니다.
- AI를 활용하면 이러한 분석 과정을 자동화할 수 있습니다.

### 2️⃣ 기본 환경 설정하기

- 주식 데이터 분석을 위한 환경을 준비합니다.

```python
# 필요한 라이브러리 가져오기
import pandas as pd
import json
import os
from pathlib import Path
from dotenv import load_dotenv
from openai import OpenAI

# .env 파일 로드하기
load_dotenv()

# API 키 가져오기
KIS_URL_BASE = os.getenv("KIS_URL_BASE")
KIS_APP_KEY = os.getenv("KIS_APP_KEY")
KIS_APP_SECRET = os.getenv("KIS_APP_SECRET")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

openai_client = OpenAI(api_key = OPENAI_API_KEY)
```

- 분석할 종목과 파일 경로를 지정합니다.

```python
market = "ovs"  # 시장 구분(국내/해외)
currency = "KRW" if market == "dom" else "USD" # 통화 단위
stock_code = "AAPL" # 종목 코드

# 파일 경로 지정하기
root_path = Path(__vsc_ipynb_file__).parent 
chart_data_path = root_path / "data"  # 차트 데이터 경로
report_path = root_path / "report"    # 보고서 저장 경로

# 경로 생성하기
chart_data_path.mkdir(parents=True, exist_ok=True)
report_path.mkdir(parents=True, exist_ok=True)
```

### 3️⃣ 간단한 기술적 분석 보고서 생성하기

- 차트 데이터를 로드하고 JSON 형식으로 변환합니다.

```python
# 차트 데이터 로드하기
df = pd.read_csv(chart_data_path / f"{stock_code}_ma.csv")

# JSON 형식으로 변환하기
df_json = df.to_json(orient="records", indent=4, force_ascii=False)
```

- 프롬프트를 두 부분으로 나누어 작성합니다.
    - 시스템(개발자) 프롬프트 prompt_tech_dev에는 AI의 역할과 작업 내용, 결과물 형식을 정의합니다.
    - 사용자 프롬프트 prompt_tech_user에는 실제 분석할 데이터를 포함합니다.

```python
# 개발자 프롬프트
prompt_tech_dev = """
너는 전문 투자 분석가야.
다음 기업의 최근 6개월 간 일봉 데이터와 기술적 지표들을 참고하여 이 기업에 대한 Markdown 형식의 기술적 분석 결과를 한국어로 출력해.
매수/매도 전략을 직접적으로 추천하지는 말고, 투자에 참고할 만한 차트 분석 결과를 제시해줘.
"""
# 사용자 프롬프트
prompt_tech_user = f"최근 주가 시세 및 이동평균 ({currency}): " + df_json
```

- OpenAI API를 호출합니다.
    - 추론 모델을 선택하고, 추론 강도를 지정합니다.

```python
# OpenAI API 호출하기
response = openai_client.chat.completions.create(
    model="o3-mini",
    messages=[
        {"role": "developer", "content": prompt_tech_dev},
        {"role": "user", "content": prompt_tech_user}
    ],
    reasoning_effort="low"
)
```

<aside>
➕

**추론형 언어 모델**

- 추론 모델은 최종 응답을 생성하기 전, 내부적인 생각 사슬(chain of thought)을 통한 추론 과정을 거칩니다.
    - 따라서 주식 분석과 같이 수치 데이터를 다루는 작업에 적합합니다.
- 내부 추론 과정을 거치기 때문에 응답 시간, 사용되는 토큰의 수가 비교적 큽니다.
    - 사용 목적, 원하는 분석의 깊이, 투입 가능한 비용을 고려하여 적절한 추론 강도나 최대 토큰 수를 지정해 사용합니다.
</aside>

- 생성 결과를 확인합니다.

```markdown
아래는 최근 6개월 일봉 데이터와 주요 이동평균선(MA5, MA20, MA60, MA120)을 기반으로 한 기술적 분석 결과입니다. 이 분석은 투자 판단의 참고자료로 활용하시기 바라며, 특정 매매 전략을 직접적으로 추천하지 않습니다.

---

### 1. 가격 추세 및 변동성  
- 전반적으로 주가는 중기(60일, 120일) 이동평균선 위와 아래를 오가며 횡보와 단기 조정 국면이 반복되고 있는 모습을 보입니다.  
- 최근 몇 주(2025년 1월 말 ~ 2월 초)에는 다소 하락세를 보이며 단기 MA5와 종가가 다소 낮은 수준에서 형성되었습니다.  
- 다만, 6개월 전보다 120일 이동평균선이 상승하는 등 장기 추세는 상승 모멘텀을 유지한 듯한 양상도 관찰됩니다.

---

### 2. 이동평균선 분석  
- MA5와 MA20의 가격 차이는 단기 모멘텀을 보여주는데, 최근 MA5(약 245.8)와 MA20(약 238.4) 간 격차는 다소 벌어져 있어 단기 상승 모멘텀의 단기적 회복 가능성을 시사할 수 있습니다.  
- 중기(MA60)와 장기(MA120) 이동평균선은 꾸준히 상승세를 유지해온 모습을 보이나, 최근 종가가 이들보다 다소 낮은 수준에서 마감하는 경우가 많아 단기 조정 국면을 암시하는 모습도 있습니다.  
- 이동평균선 간의 교차(골든 크로스 혹은 데드 크로스)의 명확한 신호는 단기적으로 관측되지는 않으나, MA5와 MA20의 상대 위치 변화에 주의할 필요가 있습니다.

---

### 3. 거래량 및 변동성 지표  
- 일부 거래일에서는 거래량이 급증하는 모습을 보였는데(예, 2024-09-20, 2024-12-20 등), 이는 중요한 가격 변동 시점에서 매수·매도 관심이 집중된 것으로 해석할 수 있습니다.  
- 최근 하락 장세와 함께 상대적으로 평균 거래량 대비 변동성이 소폭 확대된 모습이 관찰되어 단기 변동성 확대 가능성에 유의할 필요가 있습니다.

---

### 4. 최근 캔들 모양 및 단기 패턴  
- 최신 데이터(2025-02-26 기준)에서는 시가 244.33, 종가 243.46로 소폭 하락 마감하였으며, 단기 이동평균선(MA5)이 245.8 수준에서 형성되어 단기 회복세와 조정 국면이 혼재한 상태로 보입니다.  
- 단기 캔들 패턴 측면에서는, 저가와 고가 간 폭이 상대적으로 좁아지는 모습을 통해 단기 매물량 조정 및 방향 전환 가능성에 주목할 필요가 있습니다.

---

### 5. 요약 및 투자 참고 포인트  
- 장기적으로 MA120과 MA60이 상승하는 모습을 보면 상승 모멘텀은 유지되고 있으나, 단기적으로는 조정 국면과 횡보 구간이 관찰됩니다.  
- MA5와 MA20의 상대 위치 변화, 그리고 캔들 패턴 및 거래량 변동에 주의를 기울이며 추세 전환 신호(예: 단기 골든 크로스, 데드 크로스 등)를 모니터링하는 것이 도움이 될 수 있습니다.  
- 단기 변동성 확대 및 조정 국면으로 인해 투자 시 리스크 관리 및 여러 시간대의 차트 분석이 요구됩니다.

---

이상의 분석을 바탕으로 추가적 차트 분석 및 다양한 기술적 지표와의 조합을 고려하여 투자 판단하시기 바랍니다.
```

- 분석 보고서를 검토해 개선할 점을 찾습니다.
    - 데이터를 다양한 측면에서 분석하고, 결과를 요약해주었습니다.
    - 그렇지만 투자에 참고할 만한 정보보다 단순 사실을 나열하는 데 집중하고 있습니다.
    - 구체적인 날짜, 수치가 잘 드러나지 않습니다.
        - ‘다소 낮은 수준’, ‘소폭 확대’와 같은 표현은 데이터에서 어떤 부분을 말하고 있는지 분명하지 않습니다.

### 4️⃣ 상세 분석 보고서 작성하기

- 검토 결과를 반영해 프롬프트를 개선하여 더 상세한 분석을 요청합니다.
    - 프롬프트 작성 시 구체적인 지시와 예시를 제공하면 더 정확한 결과를 얻을 수 있습니다.
    - 예상 독자를 투자 초보자로 설정하여 이해하기 쉬운 보고서를 생성할 수 있습니다.

```python
# 상세 프롬프트 작성하기
prompt_tech_dev_2 = """
너는 전문 투자 분석가야. 다음 기업의 최근 6개월 간 일봉 데이터와 기술적 지표들을 참고하여 이 기업에 대한 Markdown 형식의 기술적 분석 결과를 한국어로 출력해.
매수/매도 전략을 직접적으로 추천하지는 말고, 투자에 참고할 만한 차트 분석 결과를 제시해줘.
분석 결과는 투자 초보자도 이해할 수 있는 수준으로 쉽고 자세하게 설명하고, 차트에서 주목할만한 시점이 있다면 그 날짜와 정확한 수치를 근거로 들어줘.

보고서는 주어진 JSON 구조에 맞추고, 다음 섹션들을 포함해 작성해줘.
<report_headers>
종합 요약
이동평균선 분석
주요 차트 포인트
    - 지지 및 저항 영역, 거래량 변화, 추세 전환 시점 등
결론 및 투자 시사점
</report_headers>
"""
```

- 일관된 형식의 보고서를 위해 JSON 스키마를 정의합니다.

```python
# 응답 형식 정의하기
tech_report_format = {"type": "json_schema", "json_schema": {
    "name": "technical_report",
    "schema": {
        "type": "object",
        "properties": {
            "intro": {
                "type": "string",
            },
            "technical_report": {"type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                        "heading": {"type": "string"},
                        "content": {"type": "string"}
                    },
                "required": ["heading", "content"],
                "additionalProperties": False
                },
            },
        },
        "required": ["intro", "technical_report"],
        "additionalProperties": False
        }
    }
}
```

<aside>
➕

**AI를 활용한 JSON 스키마 정의**

- JSON 형식에 익숙하지 않다면 스키마 작성까지 AI로 수행할 수 있습니다.
- 사용 목적과 필요한 항목을 분명하게 알려주도록 합니다.

```
OpenAI API 에서 response_format 옵션에 사용할 json 스키마를 정의해 주세요. 응답은 보고서 작성에 활용할 것이고, 다음 항목들을 포함해야 합니다.
- 보고서 개요
- 보고서 본문: 헤더와 내용
```

</aside>

- OpenAI API를 다시 호출합니다.
    - 개선된 개발자 프롬프트를 반영합니다.
    - response_format 옵션으로 응답 형식을 지정합니다.
    - 더 깊이 있는 분석을 위해 reasoning_effort를 medium으로 변경했습니다.

```python
# 개선된 프롬프트로 API 호출하기
response = openai_client.chat.completions.create(
    model="o3-mini",
    messages=[
        {"role": "developer", "content": prompt_tech_dev_2},
        {"role": "user", "content": prompt_tech_user}
    ],
    reasoning_effort="medium",
    response_format=tech_report_format
)
```

- 생성 결과를 확인합니다.
    - response_format 옵션을 사용하면 JSON 형식으로 응답이 반환됩니다.

```json
{
    "intro": "아래 보고서는 최근 6개월간의 일봉 데이터와 이동평균선(MA) 지표를 토대로 작성되었습니다. 보고서는 주가의 주요 흐름, 단기 및 중기 이동평균선의 상호관계, 거래량의 급증 및 주요 지지/저항 영역 등을 투자자가 쉽게 이해할 수 있도록 설명하고 있습니다. 본 보고서는 투자 결정의 참고자료로 활용할 수 있으나, 직접적인 매수/매도 권고는 포함하지 않습니다.",
    "technical_report": [
        {
            "heading": "종합 요약",
            "content": "분석기간 동안 주가는 2024년 8월 약 229달러에서 시작해 상승과 하락을 반복하며 2024년 12월 최고 259달러 근처까지 상승하였습니다. 이후 2025년 초에는 하락 조정을 보인 후 2월 말 다시 회복하는 양상을 보였습니다. 단기 변동성이 다소 큰 구간도 있었으나, 이동평균선의 흐름과 다수의 거래량 급증일을 통해 주요 전환점을 확인할 수 있습니다."
        },
        {
            "heading": "이동평균선 분석",
            "content": "단기(MA5)와 중기(MA20), 장기(MA60, MA120) 이동평균선들은 주가의 전반적인 추세 전환을 반영합니다. 초기에는 MA5가 MA20를 상회하며 상승세를 예고하였으나, 9월 초 단기선이 중기선 아래로 하락한 구간에서는 일시적인 약세 신호가 관찰되었습니다. 이후 11월 말 및 12월 초에는 MA5가 중기 및 장기선 위로 상승하며 강한 상승 전환(골든 크로스) 신호를 보였습니다. 다만, 2025년 초에는 MA5가 다시 하락세를 보이며 잠시 추세 전환의 경고를 주었으나, 2월 중순부터는 다시 단기선이 중기선을 상회하는 모습이 포착되어 회복세에 진입한 것으로 해석할 수 있습니다."
        },
        {
            "heading": "주요 차트 포인트",
            "content": "1. 지지 및 저항 영역: 2025년 1월 초에는 222 ~ 224달러 부근이 지속적인 지지선 역할을 한 것으로 보입니다. 반면, 2024년 12월에 형성된 254~259달러 부근은 단기 저항 영역으로 작용하였으며, 해당 영역에서 매물 매도 압력이 있었을 가능성이 있습니다.\n2. 거래량 변화: 2024년 9월 20일(거래량 약 3.19억)과 2024년 12월 20일(거래량 약 1.47억)처럼 특정 일자의 거래량 폭증은 기관 투자자들의 참여 또는 주요 뉴스에 따른 변동성이 반영된 결과로 해석됩니다.\n3. 추세 전환 시점: 11월 말 MA5와 MA20의 교차 및 12월 초 주가 상승은 강한 상승 전환 신호로 볼 수 있습니다. 2025년 1월 중순의 급락(예, 1월 16일 종가 228.26달러) 후 재회복하는 흐름은 단기 조정 후 엔트리 포인트로 참고될만한 전환 신호로 해석 가능합니다."
        },
        {
            "heading": "결론 및 투자 시사점",
            "content": "주가는 최근 몇 달간 상승과 조정 구간을 반복하면서 주요 이동평균선들의 교차와 거래량 급증을 통해 단기 및 중기 전환 신호를 제공하고 있습니다. 전반적으로 2월 말에는 단기 이동평균선이 중기선을 상회하는 등 회복세를 보이고 있으나, 변동성이 큰 시장 상황에서는 여러 기술적 지표를 종합적으로 참고하는 것이 중요합니다. 이번 분석은 투자 결정 시 참고자료로 활용할 수 있으며, 추가적인 펀더멘털 분석과 리스크 관리 전략을 병행하는 것이 바람직합니다."
        }
    ]
}
```

- JSON 응답을 마크다운 형식으로 변환하여 저장합니다.
    - intro와 본문 사이에 구분선(---)을 넣습니다.
    - 각 항목의 제목 heading은 제목2 형식(##)으로 표시합니다.

```python
# JSON 응답을 마크다운으로 변환하기
raw_response = json.loads(response.choices[0].message.content)
report_md = f"{raw_response['intro']}\\n\\n"
report_md += "---\\n\\n"
for item in raw_response['technical_report']:
    report_md += f"## {item['heading']}\\n\\n"
    report_md += f"{item['content']}\\n\\n"

# 마크다운 파일로 저장하기
with open(report_path / f"{stock_code}_v2.md", "w") as f:
    f.write(report_md)
```

```markdown
아래 보고서는 최근 6개월간의 일봉 데이터와 이동평균선(MA) 지표를 토대로 작성되었습니다. 보고서는 주가의 주요 흐름, 단기 및 중기 이동평균선의 상호관계, 거래량의 급증 및 주요 지지/저항 영역 등을 투자자가 쉽게 이해할 수 있도록 설명하고 있습니다. 본 보고서는 투자 결정의 참고자료로 활용할 수 있으나, 직접적인 매수/매도 권고는 포함하지 않습니다.

---

## 종합 요약

분석기간 동안 주가는 2024년 8월 약 229달러에서 시작해 상승과 하락을 반복하며 2024년 12월 최고 259달러 근처까지 상승하였습니다. 이후 2025년 초에는 하락 조정을 보인 후 2월 말 다시 회복하는 양상을 보였습니다. 단기 변동성이 다소 큰 구간도 있었으나, 이동평균선의 흐름과 다수의 거래량 급증일을 통해 주요 전환점을 확인할 수 있습니다.

## 이동평균선 분석

단기(MA5)와 중기(MA20), 장기(MA60, MA120) 이동평균선들은 주가의 전반적인 추세 전환을 반영합니다. 초기에는 MA5가 MA20를 상회하며 상승세를 예고하였으나, 9월 초 단기선이 중기선 아래로 하락한 구간에서는 일시적인 약세 신호가 관찰되었습니다. 이후 11월 말 및 12월 초에는 MA5가 중기 및 장기선 위로 상승하며 강한 상승 전환(골든 크로스) 신호를 보였습니다. 다만, 2025년 초에는 MA5가 다시 하락세를 보이며 잠시 추세 전환의 경고를 주었으나, 2월 중순부터는 다시 단기선이 중기선을 상회하는 모습이 포착되어 회복세에 진입한 것으로 해석할 수 있습니다.

## 주요 차트 포인트

1. 지지 및 저항 영역: 2025년 1월 초에는 222 ~ 224달러 부근이 지속적인 지지선 역할을 한 것으로 보입니다. 반면, 2024년 12월에 형성된 254~259달러 부근은 단기 저항 영역으로 작용하였으며, 해당 영역에서 매물 매도 압력이 있었을 가능성이 있습니다.
2. 거래량 변화: 2024년 9월 20일(거래량 약 3.19억)과 2024년 12월 20일(거래량 약 1.47억)처럼 특정 일자의 거래량 폭증은 기관 투자자들의 참여 또는 주요 뉴스에 따른 변동성이 반영된 결과로 해석됩니다.
3. 추세 전환 시점: 11월 말 MA5와 MA20의 교차 및 12월 초 주가 상승은 강한 상승 전환 신호로 볼 수 있습니다. 2025년 1월 중순의 급락(예, 1월 16일 종가 228.26달러) 후 재회복하는 흐름은 단기 조정 후 엔트리 포인트로 참고될만한 전환 신호로 해석 가능합니다.

## 결론 및 투자 시사점

주가는 최근 몇 달간 상승과 조정 구간을 반복하면서 주요 이동평균선들의 교차와 거래량 급증을 통해 단기 및 중기 전환 신호를 제공하고 있습니다. 전반적으로 2월 말에는 단기 이동평균선이 중기선을 상회하는 등 회복세를 보이고 있으나, 변동성이 큰 시장 상황에서는 여러 기술적 지표를 종합적으로 참고하는 것이 중요합니다. 이번 분석은 투자 결정 시 참고자료로 활용할 수 있으며, 추가적인 펀더멘털 분석과 리스크 관리 전략을 병행하는 것이 바람직합니다.
```

<aside>
➕

**마크다운(Markdown) 형식의 장점**

- 마크다운은 간단한 기호를 사용해 가독성 좋은 서식을 지정할 수 있습니다.
- 제목, 목록, 강조, 인용 등 다양한 서식을 쉽게 적용할 수 있습니다.
- 텍스트 에디터에서 쉽게 편집할 수 있고, HTML로 변환도 가능합니다.
</aside>