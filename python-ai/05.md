안녕하세요, 여러분! 반갑습니다.
지난 시간에 데이터를 가져오는 것까지 해보았는데요, 오늘은 우리에게 좀 더 친숙한 형태인 차트를 그려보도록 하겠습니다.

먼저 plotly(플랏리) 라이브러리에 대해 소개해드릴게요.
plotly는 파이썬으로 그래프와 차트를 그릴 수 있는 오픈 소스 라이브러리인데요,
여러 가지 장점들이 있습니다.

첫째로, pandas 라이브러리와 호환성이 좋아서 DataFrame을 원하는 형식의 그래프로 쉽게 그릴 수 있고,
둘째로, '인터랙티브'라는 특징 때문에 풍부한 상호작용으로 데이터를 쉽게 이해할 수 있습니다.
또한 코스 후반부에서 제작하게 될 대시보드와의 통합이 쉽고,
특히 여러 전문 데이터에 특화된 그래프 클래스를 다양하게 제공한다는 장점이 있죠.

오늘은 이 중에서도 금융 데이터에 특화된 캔들스틱(Candlestick) 클래스를 활용해서 차트를 그려볼 텐데요,
날짜 데이터와 OHLC(오 에이치 엘 씨) 데이터만 주면 주식 차트 모양으로 그려준답니다.
~~참고로 우리나라에서 봉차트라고 부르는 것을 영어로는 보통 캔들 차트라고 합니다.~~

자, 그럼 우리가 그래프에 어떤 정보를 표시할지 정리해볼까요?
보통 주식 거래 프로그램을 보면 위쪽에 시세가 나와있는 캔들 차트가 있고, 아래쪽에는 거래량 그래프가 있죠?
우리도 일별 시세는 캔들 차트로,
거래량은 막대 그래프로 그려서
이 두 개의 그래프를 위 아래로 나란히 표시해보도록 하겠습니다.

---

~~이제 실제로 candlestick_chart(캔들스틱 차트) 함수를 구현해볼 텐데요,~~

먼저 이전에 저장했던 일봉 데이터 CSV 파일을 가져옵니다.

plotly 라이브러리의
make_subplots(메이크 서브 플랏츠)라는 함수로 한 번에 여러 개의 그래프를 그릴 수 있습니다.
여기서 생성되는 fig 변수는 그래프를 그릴 도화지 전체라고 생각하시면 됩니다.

graph_objects(그래프 오브젝트), 줄여서 go(지오)는 개별 그래프를 생성하는 모듈인데요,
~~우리는 여기서 캔들 차트를 위한 Candlestick(캔들스틱)과 거래량 표시를 위한 Bar 클래스를 사용할 거예요.~~

Candlestick에는 가로축에 날짜 데이터를,
그리고 시가, 고가, 저가, 종가 데이터를 각각 넣어주면 됩니다.

```python
plotly.graph_objects.Candlestick(x, open, high, low, close)
	x: 가로축 (날짜 데이터)
	open: 시가
	high: 고가
	low: 저가
	close: 종가
```

거래량 바 차트는 ~~좀 더 재미있게 만들어볼 건데요,~~
종가에서 시가를 뺀 값으로 가격이 상승했는지 하락했는지 계산해서
상승했으면 빨간색, 하락했으면 파란색으로 막대 색상을 다르게 표시해보도록 하겠습니다.

```python
plotly.graph_objects.Bar(x, y, marker, name)
	x: 가로축 (날짜 데이터)
	y: 세로축 (거래량 데이터)
	marker: 색상 등 막대 특성 설정
	name: 그래프 제목
```

이렇게 만든 그래프들을 add_trace(애드 트레이스) 함수로 도화지에 그려주는데요,
여러 개의 칸이 있으니까 행과 열 번호를 지정해줍니다.

x축은 ~~날짜 포맷을 그대로 출력하고 싶으니까~~, type(타입)을 category(카테고리)로 설정하고,
~~x축의 범위를 조정하는 슬라이딩바는 두 그래프를 한눈에 보는 데 방해될 수 있어서 제거하도록 하겠습니다.~~

이 모든 과정을 candlestick_chart라는 함수로 만들어서,
종목코드만 입력하면 자동으로 해당 종목의 차트를 그려주도록 했습니다.

```python
def candlestick_chart(stock_code: str):
    df = pd.read_csv(f"{stock_code}_ohlcv.csv")
    df["datetime"] = pd.to_datetime(
                      df["datetime"]).dt.strftime("%y-%m-%d")

    # 2개의 subplot 생성, 2행으로 배치 (캔들차트, 거래량)
    fig = make_subplots(rows=2, cols=1, shared_xaxes=True,
                vertical_spacing=0.1,
                subplot_titles=('AAPL 주가', '거래량'),
                row_heights=[0.7, 0.3])

    fig.update_layout(
        font=dict(size=14),          # 전체 기본 폰트 크기
        legend=dict(font=dict(size=18))  # 범례 폰트 크기
    )

    # 하단 range slider 제거
    fig.update(layout_xaxis_rangeslider_visible = False)

    # 캔들스틱 차트 추가 (첫번째 subplot)
    fig.add_trace(go.Candlestick(
        x=df['datetime'],
        open=df['open'],
        high=df['high'],
        low=df['low'],
        close=df['close'],
        name='AAPL',
        increasing_line_color='red',
        decreasing_line_color='blue'
    ), row=1, col=1)

    # 가격 변화에 따른 거래량 막대 색상 설정
    # 가격 변화 계산: 종가 - 시가
    df['change'] = df['close'] - df['open']
    # 상승 시 빨간색
    df.loc[df['change'] >= 0,'VolumeColor'] = 'red'
    # 하락 시 파랑색
    df.loc[df['change'] < 0,'VolumeColor'] = 'blue'

    # 거래량 바 차트 추가 (두번째 subplot)
    fig.add_trace(go.Bar(
                    x = df['datetime'],
                    y = df['volume'],
                    marker = dict(color = df['VolumeColor']),
                    name = '거래량'
                ), row = 2, col = 1)

    # x축 타입을 category로 설정
    fig.update_xaxes(type = "category", dtick=15)

    fig.update_layout(
        title='애플(AAPL) 주가 차트',
        yaxis_title='주가 (USD)',
        yaxis2_title='거래량',
        xaxis_rangeslider_visible = False,
        height=600,
    )

    return fig

```

자, 이제 실행해보면 꽤 그럴듯한 차트가 나오는 걸 볼 수 있는데요!
주가와 거래량의 변화 추세를 한눈에 알아볼 수 있고,
그래프에 커서를 올리면 확대도 하고, 이동도 하고, 각 데이터 값도 확인할 수 있습니다.

~~하지만 여기서 변화 추세를 좀 더 정확하게 알 수 있으면 좋겠죠?~~

다음 강의에서는 이동평균선 등 다른 지표를 추가해보도록 하겠습니다.
그럼 다음 시간에 만나요!

---

### 1️⃣ plotly 라이브러리 소개

- plotly는 파이썬에서 그래프와 차트를 그릴 수 있는 오픈 소스 라이브러리입니다.
  - pandas와의 호환성이 좋아 DataFrame을 쉽게 시각화할 수 있습니다.
  - 인터랙티브한 기능으로 데이터를 쉽게 이해할 수 있습니다.
- 금융 데이터 시각화를 위한 Candlestick 클래스를 제공합니다.

### 2️⃣ 주식 차트 구현하기

- 주식 차트는 캔들 차트와 거래량 차트로 구성됩니다.
- make_subplots 함수로 여러 개의 그래프를 동시에 그릴 수 있습니다.
- graph_objects 모듈의 Candlestick과 Bar 클래스를 사용합니다.

```python
# 주식 차트 그리기 위한 기본 설정하기
import plotly
from plotly.subplots import make_subplots
import plotly.graph_objects as go

stock_code = "AAPL"
df = pd.read_csv(f"{stock_code}_ohlcv.csv")
df["datetime"] = pd.to_datetime(
                  df["datetime"]).dt.strftime("%y-%m-%d")

# 2개의 subplot 생성, 2행으로 배치 (캔들차트, 거래량)
fig = make_subplots(rows=2, cols=1, shared_xaxes=True,
            vertical_spacing=0.1,
            subplot_titles=('AAPL 주가', '거래량'),
            row_heights=[0.7, 0.3])

fig.update_layout(
    font=dict(size=14),          # 전체 기본 폰트 크기
    legend=dict(font=dict(size=18))  # 범례 폰트 크기
)
```

```python
# 캔들스틱 차트 추가하기
fig.add_trace(
    go.Candlestick(
        x=df['datetime'],
        open=df["open"],
        high=df["high"],
        low=df["low"],
        close=df["close"],
        name='AAPL',
        increasing_line_color="red",
        decreasing_line_color="blue",
    ),
    row=1,
    col=1,
)
```

```python
# 거래량 차트 추가하기
df['change'] = df['close'] - df['open']
df.loc[df['change'] >= 0,'VolumeColor'] = 'red'   # 상승 시 빨간색
df.loc[df['change'] < 0,'VolumeColor'] = 'blue'   # 하락 시 파랑색

# 거래량 바 차트 추가
fig.add_trace(
    go.Bar(
	      x = df['datetime'],
	      y = df['volume'],
        marker = dict(color = df['VolumeColor']),
        name="거래량",
    ),
    row=2,
    col=1,
)
```

```python
# x축 타입을 category로 설정
fig.update_xaxes(type = "category", dtick=15)

fig.update_layout(
    title='애플(AAPL) 주가 차트',
    yaxis_title='주가 (USD)',
    yaxis2_title='거래량',
    xaxis_rangeslider_visible = False,
    height=600,
)
```

<aside>
➕ **plotly 모듈의 주요 기능**

- make_subplots: 여러 그래프를 하나의 화면에 배치할 수 있습니다.
- add_trace: 생성한 그래프를 도화지에 추가합니다.
- update_xaxes: x축의 속성을 설정합니다.
</aside>

<aside>
⚠️ **여기서 잠깐!**

- 차트의 x축은 날짜 형식을 유지하기 위해 반드시 type을 "category"로 설정해야 합니다.
- 거래량 차트의 색상은 가격 변화에 따라 다르게 표시하면 추세 파악이 쉽습니다.
</aside>
